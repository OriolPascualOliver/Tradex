<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Configuración · FixHub</title>
  <link rel="stylesheet" href="/css/style.css?v={cachebust}"/>
  <style>
    .section-head { display:flex; align-items:center; gap:.6rem; }
    .hint-right { margin-left:auto; color:var(--muted); font-size:.9rem; }
    .inline { display:flex; gap: var(--s3); align-items:center; flex-wrap:wrap; }
    .chip { display:inline-grid; place-items:center; width:28px; height:28px; border-radius:999px; border:1px solid var(--border); background:#fff; }
    .spinner { width:16px; height:16px; border:2px solid #ccc; border-top-color: var(--sky); border-radius:50%; animation: spin .6s linear infinite; display:inline-block; vertical-align:middle;}
    @keyframes spin { to { transform: rotate(360deg) } }
    .preview-box { border:1px dashed var(--border); border-radius:12px; min-height:140px; display:grid; place-items:center; color:var(--muted);}
    .toolbar-right { display:flex; gap:.5rem; align-items:center; margin-left:auto; }
    .row { display:flex; gap: var(--s4); align-items:flex-end; flex-wrap:wrap; }
    .w240{ width:240px; }
  </style>
</head>
<body>
<!--#include "partials/header.html" -->

<main class="layout">
  <nav class="breadcrumb"><a href="./index.html">Inicio</a> &gt; Configuración</nav>
  <h1 class="page-title">Configuración</h1>
  <p class="page-desc">Ajusta parámetros de IA, tarifas, proveedores y branding para automatizar tus presupuestos.</p>
  <section class="grid">

    <!-- IA y presets -->
    <article id="ia" class="card">
      <div class="section-head">
        <h3 style="margin:0;">IA y presets</h3>
        <span class="hint-right">Sube mínimo 3 presupuestos previos</span>
      </div>

      <div class="row">
        <label class="w240">
          <span>Subir archivo(s)</span>
          <input id="aiFiles" type="file" multiple />
        </label>

        <button id="btnUploadAI" class="btn secondary">Subir archivo</button>

        <div class="inline">
          <span>Subidos</span><strong id="aiUploaded">0</strong>
          <span>Estado</span><span id="aiStatus" class="badge badge-idle">ℹ️ Sin datos</span>
        </div>
        <div id="aiFileStatus" class="file-list" style="width:100%;"></div>

        <div class="toolbar-right">
          <button id="btnTrain" class="btn primary">
            <span class="chip">⚙️</span> Entrenar IA
          </button>
          <button id="btnResetAI" class="btn secondary">Resetear</button>
          <button id="btnDownloadModel" class="btn secondary">Descargar modelo</button>
        </div>
      </div>
      <div id="trainHint" class="hint" style="margin-top:.6rem; display:none;">
        Entrenando… <span class="spinner"></span>
      </div>
    </article>

    <!-- Tarifas y márgenes -->
    <article id="tarifas" class="card">
      <h3 style="margin-top:0;">Tarifas y márgenes</h3>

      <div class="grid" style="grid-template-columns: repeat(3, 1fr);">
        <label>€/hora <input id="rateHour" class="input" type="number" placeholder="45" step="1"></label>

        <label>Mínimo computable
          <select id="minBlock" class="input">
            <!-- 5' steps up to 120' -->
          </select>
        </label>

        <label>Escalado de tiempo
          <select id="stepBlock" class="input">
            <!-- 5' steps up to 120' -->
          </select>
        </label>

        <label>Markup materiales (%) <input id="markup" class="input" type="number" placeholder="20" step="1"></label>
        <label>IVA (%) <input id="vat" class="input" type="number" placeholder="21" step="1"></label>
        <label>Coste desplazamiento (€/km) <input id="travelKm" class="input" type="number" placeholder="0.5" step="0.1"></label>
      </div>

      <div class="toolbar" style="justify-content:flex-end; margin-top: var(--s3);">
        <button id="btnSaveTariffs" class="btn primary">Guardar</button>
      </div>
    </article>

    <!-- Proveedores -->
    <article id="proveedor" class="card">
      <h3>Proveedores</h3>
      <div class="row">
        <label class="w240">
          <span>Proveedor por defecto</span>
          <select id="provider" class="input">
            <option value="Bricomart">Bricomart</option>
            <option value="Leroy Merlin">Leroy Merlin</option>
            <option value="Amazon Business">Amazon Business</option>
            <option value="other">Otro (manual)</option>
          </select>
        </label>

        <label class="w240" id="otherProviderWrap" style="display:none;">
          <span>Nombre proveedor</span>
          <input id="otherProvider" class="input" placeholder="Nombre"/>
        </label>

        <label class="w240">
          <span>Subir catálogo</span>
          <input id="providerCatalog" type="file" />
        </label>

        <button id="btnUploadCatalog" class="btn secondary">Subir archivo</button>

        <div class="inline">
          <span>Estado:</span>
          <span id="catalogStatus" class="badge badge-idle">ℹ️ Sin datos</span>
        </div>

        <div class="toolbar-right">
          <button id="btnSaveProvider" class="btn primary">Guardar</button>
        </div>
      </div>
    </article>

    <!-- Documentación y prefijos -->
    <article id="prefijos" class="card">
      <h3>Documentación y prefijos</h3>
      <div class="grid" style="grid-template-columns: repeat(2, 1fr);">
        <div class="grid" style="grid-template-columns: repeat(3, 1fr);">
          <label>Presupuestos <input id="prefQuote" class="input" placeholder="PRES-2025-"/></label>
          <label>Facturas <input id="prefInvoice" class="input" placeholder="FACT-"/></label>
          <label>Partes <input id="prefWork" class="input" placeholder="PAR-"/></label>
        </div>
        <div class="grid" style="grid-template-columns: repeat(3, 1fr);">
          <label>Reset contador Presupuestos <input id="resetQuote" class="input" type="number" placeholder="1"/></label>
          <label>Reset contador Facturas <input id="resetInvoice" class="input" type="number" placeholder="1"/></label>
          <label>Reset contador Partes <input id="resetWork" class="input" type="number" placeholder="1"/></label>
        </div>
      </div>
      <p class="hint">El siguiente número se recalculará automáticamente al guardar.</p>
      <div class="toolbar" style="justify-content:flex-end;">
        <button id="btnSavePrefixes" class="btn primary">Guardar</button>
      </div>
    </article>

    <!-- Datos fiscales -->
    <article id="fiscal" class="card">
      <h3>Datos fiscales</h3>
      <div class="grid" style="grid-template-columns: repeat(2, 1fr);">
        <label>Nombre fiscal <input id="taxName" class="input" /></label>
        <label>NIF/CIF <input id="taxId" class="input" /></label>
        <label>Dirección <input id="taxAddress" class="input" placeholder="C/ Mayor 123, Madrid" /></label>
        <label>Ciudad / CP <input id="taxCityZip" class="input" placeholder="Madrid, 28080" /></label>
      </div>
      <div class="toolbar" style="justify-content:flex-end;">
        <button id="btnSaveFiscal" class="btn primary">Guardar</button>
      </div>
    </article>

    <!-- Branding -->
    <article id="branding" class="card">
      <h3>Branding de documentos</h3>
      <div class="grid" style="grid-template-columns: 1fr 1fr;">
        <div class="wire" style="padding:12px;">
          <label>Logo <input id="logoFile" type="file" accept="image/*"/></label>
          <div id="logoPreview" class="preview-box" style="margin-top:.6rem;">
            <span>Vista previa</span>
          </div>
        </div>
        <div>
          <label>Modelo de factura</label>
          <select id="tplInvoice" class="input">
            <option value="A">Modelo A</option>
            <option value="B">Modelo B</option>
          </select>
          <label style="margin-top:.6rem;">Modelo de presupuesto</label>
          <div class="inline">
            <select id="tplQuote" class="input">
              <option value="A">Modelo A</option>
              <option value="B">Modelo B</option>
            </select>
            <button id="btnPreviewBrand" class="btn secondary">Preview</button>
          </div>
          <div class="toolbar" style="justify-content:flex-end; margin-top: var(--s3);">
            <button id="btnSaveBranding" class="btn primary">Guardar</button>
          </div>
        </div>
      </div>
    </article>

    <!-- Modelo de email -->
    <article id="email" class="card">
      <h3>Modelo de email</h3>
      <label>Asunto <input id="emailSubject" class="input" placeholder="Tu presupuesto {numero}"/></label>
      <label style="margin-top:.6rem;">Cuerpo <span class="help-icon" title="Variables disponibles: {cliente}, {importe}, {enlace}, {numero}">?</span></label>
      <textarea id="emailBody" class="input" placeholder="Hola {cliente}, adjuntamos tu presupuesto por importe {importe}. Enlace: {enlace}"></textarea>
      <div id="emailPreview" class="preview-box" style="margin-top:.6rem; text-align:left;"></div>
      <div class="toolbar" style="justify-content:flex-end; margin-top: var(--s3);">
        <button id="btnSaveEmail" class="btn primary">Guardar</button>
      </div>
    </article>

  </section>
</main>

<!--#include "partials/footer.html" -->

<script>
const API = location.origin.replace(/\/$/, ''); // adjust if FE+BE on different hosts

function setBadge(el, status){
  el.className = 'badge';
  switch(status){
    case 'processing':
      el.classList.add('badge-processing'); el.textContent = '⏳ Procesando'; break;
    case 'ok':
      el.classList.add('badge-ok'); el.textContent = '✅ Completado'; break;
    case 'error':
      el.classList.add('badge-error'); el.textContent = '❌ Error'; break;
    default:
      el.classList.add('badge-idle'); el.textContent = 'ℹ️ Sin datos';
  }
}

function showToast(msg){
  const t=document.createElement('div');
  t.className='toast';
  t.textContent=msg;
  document.body.appendChild(t);
  requestAnimationFrame(()=>t.classList.add('show'));
  setTimeout(()=>{t.classList.remove('show'); t.remove();},3000);
}

// Fill 5' steps up to 60 then 1h format
function fillSteps(sel){
  sel.innerHTML='';
  for(let m=5;m<=180;m+=5){
    const o=document.createElement('option');
    o.value=m;
    if(m<60){ o.textContent=`${m}'`; }
    else {
      const h=Math.floor(m/60); const mm=m%60;
      o.textContent= mm? `${h}h${mm}'` : `${h}h`;
    }
    sel.appendChild(o);
  }
}

const minBlock = document.getElementById('minBlock');
const stepBlock = document.getElementById('stepBlock');
fillSteps(minBlock); fillSteps(stepBlock);

// Provider "other"
const provider = document.getElementById('provider');
const otherWrap = document.getElementById('otherProviderWrap');
provider.addEventListener('change', () => {
  otherWrap.style.display = provider.value === 'other' ? '' : 'none';
});
const catalogStatus = document.getElementById('catalogStatus');

// Branding preview
const logoFile = document.getElementById('logoFile');
const logoPreview = document.getElementById('logoPreview');
logoFile.addEventListener('change', () => {
  const f = logoFile.files[0]; if(!f) return;
  const reader = new FileReader();
  reader.onload = e => {
    logoPreview.innerHTML = `<img src="${e.target.result}" alt="logo" style="max-width:100%; max-height:120px; object-fit:contain;">`;
  };
  reader.readAsDataURL(f);
});

// Email preview
const emailSubject = document.getElementById('emailSubject');
const emailBody = document.getElementById('emailBody');
const emailPreview = document.getElementById('emailPreview');
function updateEmailPreview(){
  const dummy = { cliente:'Juan', importe:'450€', enlace:'fixhub.com/presupuesto/2025', numero:'PRES-2025' };
  const subj = (emailSubject.value || emailSubject.placeholder)
    .replace('{cliente}', dummy.cliente)
    .replace('{importe}', dummy.importe)
    .replace('{enlace}', dummy.enlace)
    .replace('{numero}', dummy.numero);
  const body = (emailBody.value || emailBody.placeholder)
    .replace('{cliente}', dummy.cliente)
    .replace('{importe}', dummy.importe)
    .replace('{enlace}', dummy.enlace)
    .replace('{numero}', dummy.numero);
  emailPreview.innerHTML = `<strong>Asunto:</strong> ${subj}<br><strong>Cuerpo:</strong> ${body}`;
}
emailSubject.addEventListener('input', updateEmailPreview);
emailBody.addEventListener('input', updateEmailPreview);
updateEmailPreview();

// ---- IA actions
const aiFiles = document.getElementById('aiFiles');
const aiUploaded = document.getElementById('aiUploaded');
const btnUploadAI = document.getElementById('btnUploadAI');
const btnTrain = document.getElementById('btnTrain');
const btnResetAI = document.getElementById('btnResetAI');
const btnDownloadModel = document.getElementById('btnDownloadModel');
const aiStatus = document.getElementById('aiStatus');
const trainHint = document.getElementById('trainHint');
const aiFileStatus = document.getElementById('aiFileStatus');

btnUploadAI.onclick = async () => {
  if(aiFiles.files.length===0){
    aiFileStatus.textContent = '❌ No se han proporcionado archivos';
    setBadge(aiStatus,'idle');
    return;
  }
  aiFileStatus.innerHTML = Array.from(aiFiles.files).map(f=>`${f.name} ⏳`).join('<br>');
  setBadge(aiStatus,'processing');
  const fd = new FormData();
  [...aiFiles.files].forEach(f => fd.append('files', f));
  const r = await fetch(`${API}/settings/ai/uploads`, { method:'POST', body: fd });
  const j = await r.json();
  aiUploaded.textContent = j.count ?? 0;
  aiFileStatus.innerHTML = Array.from(aiFiles.files).map(f=>`${f.name} ✅`).join('<br>');
  setBadge(aiStatus, j.status || 'ok');
};

btnTrain.onclick = async () => {
  trainHint.style.display = '';
  btnTrain.disabled = true;
  setBadge(aiStatus,'processing');
  const r = await fetch(`${API}/settings/ai/train`, { method:'POST' });
  const j = await r.json().catch(()=>({}));
  setBadge(aiStatus, j.status || 'processing');
  setTimeout(async () => { // poll once for MVP
    const rr = await fetch(`${API}/settings/ai/status`);
    const jj = await rr.json();
    setBadge(aiStatus, jj.status || 'ok');
    trainHint.style.display = 'none';
    btnTrain.disabled = false;
  }, 2500);
};

btnResetAI.onclick = async () => {
  await fetch(`${API}/settings/ai/reset`, { method:'POST' });
  aiUploaded.textContent = '0';
  aiFileStatus.textContent = '';
  setBadge(aiStatus,'idle');
};

btnDownloadModel.onclick = () => { window.location = `${API}/settings/ai/model`; };

// ---- SAVE handlers
async function saveJSON(url, payload, okMsg){
  const r = await fetch(url, {
    method:'PUT',
    headers:{ 'Content-Type':'application/json' },
    body: JSON.stringify(payload)
  });
  if(!r.ok){ alert('Error guardando'); return; }
  showToast(okMsg || 'Guardado correctamente');
}

document.getElementById('btnSaveTariffs').onclick = () => saveJSON(`${API}/settings/tariffs`, {
  rate_hour: +document.getElementById('rateHour').value,
  min_minutes: +document.getElementById('minBlock').value,
  step_minutes: +document.getElementById('stepBlock').value,
  markup_percent: +document.getElementById('markup').value,
  vat_percent: +document.getElementById('vat').value,
  travel_per_km: +document.getElementById('travelKm').value
}, 'Tarifas guardadas correctamente');

document.getElementById('btnSaveProvider').onclick = async () => {
  const chosen = provider.value === 'other' ? document.getElementById('otherProvider').value : provider.value;
  await saveJSON(`${API}/settings/provider`, { default_provider: chosen }, 'Proveedor guardado');
};

document.getElementById('btnUploadCatalog').onclick = async () => {
  const file = document.getElementById('providerCatalog').files[0];
  if(!file){
    catalogStatus.className='badge badge-error';
    catalogStatus.textContent='❌ No se han proporcionado archivos';
    return;
  }
  catalogStatus.className='badge badge-processing';
  catalogStatus.textContent=`⏳ ${file.name}`;
  const fd = new FormData();
  fd.append('file', file);
  const r = await fetch(`${API}/settings/provider/catalog`, { method:'POST', body: fd });
  const j = await r.json();
  catalogStatus.className = j.status === 'error' ? 'badge badge-error' : 'badge badge-ok';
  catalogStatus.textContent = `${j.status === 'error' ? '❌' : '✅'} ${file.name}`;
};

document.getElementById('btnSavePrefixes').onclick = () => saveJSON(`${API}/settings/prefixes`, {
  quote_prefix: document.getElementById('prefQuote').value,
  invoice_prefix: document.getElementById('prefInvoice').value,
  work_prefix: document.getElementById('prefWork').value,
  reset: {
    quote_next: +document.getElementById('resetQuote').value || null,
    invoice_next: +document.getElementById('resetInvoice').value || null,
    work_next: +document.getElementById('resetWork').value || null
  }
}, 'Prefijos guardados');

document.getElementById('btnSaveFiscal').onclick = () => saveJSON(`${API}/settings/fiscal`, {
  legal_name: document.getElementById('taxName').value,
  tax_id: document.getElementById('taxId').value,
  address: document.getElementById('taxAddress').value,
  city_zip: document.getElementById('taxCityZip').value
}, 'Datos fiscales guardados');

document.getElementById('btnSaveBranding').onclick = async () => {
  // upload logo if selected
  const lf = document.getElementById('logoFile').files[0];
  if(lf){
    const fd = new FormData(); fd.append('file', lf);
    await fetch(`${API}/settings/branding/logo`, { method:'POST', body: fd });
  }
  await saveJSON(`${API}/settings/branding`, {
    invoice_template: document.getElementById('tplInvoice').value,
    quote_template: document.getElementById('tplQuote').value
  }, 'Branding guardado');
};

document.getElementById('btnPreviewBrand').onclick = () => window.open(`${API}/settings/branding/preview`, '_blank');

document.getElementById('btnSaveEmail').onclick = () => saveJSON(`${API}/settings/email-template`, {
  subject: document.getElementById('emailSubject').value,
  body: document.getElementById('emailBody').value
}, 'Email guardado');

// ---- Load initial values
(async function boot(){
  try{
    const r = await fetch(`${API}/settings`);
    if(!r.ok) return;
    const s = await r.json();

    // Map settings to fields (all optional)
    document.getElementById('rateHour').value = s.tariffs?.rate_hour ?? '';
    document.getElementById('minBlock').value = s.tariffs?.min_minutes ?? '30';
    document.getElementById('stepBlock').value = s.tariffs?.step_minutes ?? '30';
    document.getElementById('markup').value = s.tariffs?.markup_percent ?? '';
    document.getElementById('vat').value = s.tariffs?.vat_percent ?? '';
    document.getElementById('travelKm').value = s.tariffs?.travel_per_km ?? '';

    if(s.provider?.default_provider){
      if(['Bricomart','Leroy Merlin','Amazon Business'].includes(s.provider.default_provider)){
        provider.value = s.provider.default_provider;
        otherWrap.style.display='none';
      } else {
        provider.value = 'other';
        otherWrap.style.display='';
        document.getElementById('otherProvider').value = s.provider.default_provider;
      }
    }

    document.getElementById('prefQuote').value = s.prefixes?.quote_prefix ?? '';
    document.getElementById('prefInvoice').value = s.prefixes?.invoice_prefix ?? '';
    document.getElementById('prefWork').value = s.prefixes?.work_prefix ?? '';

    document.getElementById('taxName').value = s.fiscal?.legal_name ?? '';
    document.getElementById('taxId').value = s.fiscal?.tax_id ?? '';
    document.getElementById('taxAddress').value = s.fiscal?.address ?? '';
    document.getElementById('taxCityZip').value = s.fiscal?.city_zip ?? '';

    document.getElementById('tplInvoice').value = s.branding?.invoice_template ?? 'A';
    document.getElementById('tplQuote').value = s.branding?.quote_template ?? 'A';

    document.getElementById('emailSubject').value = s.email_template?.subject ?? '';
    document.getElementById('emailBody').value = s.email_template?.body ?? '';
    updateEmailPreview();
  }catch(e){ /* noop */ }
})();
</script>
</body>
</html>
