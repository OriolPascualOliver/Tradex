<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Configuraci√≥n ¬∑ FixHub</title>
  <link rel="stylesheet" href="/css/style.css?v={cachebust}"/>
  <style>
    .section-head { display:flex; align-items:center; gap:.6rem; }
    .hint-right { margin-left:auto; color:var(--muted); font-size:.9rem; }
    .inline { display:flex; gap: var(--s3); align-items:center; flex-wrap:wrap; }
    .chip { display:inline-grid; place-items:center; width:28px; height:28px; border-radius:999px; border:1px solid var(--border); background:#fff; }
    .spinner { width:16px; height:16px; border:2px solid #ccc; border-top-color: var(--sky); border-radius:50%; animation: spin .6s linear infinite; display:inline-block; vertical-align:middle;}
    @keyframes spin { to { transform: rotate(360deg) } }
    .preview-box { border:1px dashed var(--border); border-radius:12px; min-height:140px; display:grid; place-items:center; color:var(--muted);}
    .toolbar-right { display:flex; gap:.5rem; align-items:center; margin-left:auto; }
    .row { display:flex; gap: var(--s4); align-items:center; flex-wrap:wrap; }
    .w240{ width:240px; }
    .upload-status{ font-size:.85rem; margin-top:4px; }
  </style>
</head>
<body>
<!--#include "partials/header.html" -->

<main>
  <h2>Configuraci√≥n</h2>
  <section class="grid">

    <!-- IA y presets -->
    <article id="ia" class="card">
      <div class="section-head">
        <h3 style="margin:0;">ü§ñ IA y presets</h3>
        <span class="hint-right">Sube m√≠nimo 3 presupuestos previos</span>
      </div>

      <div class="row">
        <div class="w240">
          <span>Subir archivo(s)</span>
          <label id="aiDrop" class="drop-zone">Arrastra o haz clic<input id="aiFiles" type="file" multiple></label>
          <div id="aiFileStatus" class="upload-status"></div>
        </div>

        <button id="btnUploadAI" class="btn secondary">Subir archivo</button>

        <div class="inline">
          <span>Subidos</span><strong id="aiUploaded">0</strong>
          <span>Estado:</span><span id="aiStatus" class="badge idle">Sin entrenar</span>
        </div>
      </div>
      <div class="toolbar" style="justify-content:flex-end; margin-top: var(--s3);">
        <button id="btnTrain" class="btn primary"><span class="chip">‚öôÔ∏è</span> Entrenar IA</button>
        <button id="btnResetAI" class="btn secondary danger">Resetear</button>
        <button id="btnDownloadModel" class="btn tertiary">Descargar modelo</button>
      </div>
      <div id="trainHint" class="hint" style="margin-top:.6rem; display:none;">
        Entrenando‚Ä¶ <span class="spinner"></span>
      </div>
    </article>

    <!-- Tarifas y m√°rgenes -->
    <article id="tarifas" class="card">
      <h3 style="margin-top:0;">‚öôÔ∏è Tarifas y m√°rgenes</h3>

      <div class="grid" style="grid-template-columns: repeat(3, 1fr);">
        <label>‚Ç¨/hora <input id="rateHour" class="input" type="number" placeholder="45" step="1"></label>

        <label>M√≠nimo computable</label>
        <div id="minBlock" class="segmented" style="margin-bottom:var(--s4);"></div>

        <label>Escalado de tiempo</label>
        <div id="stepBlock" class="segmented" style="margin-bottom:var(--s4);"></div>

        <details class="advanced" style="grid-column:1/-1; margin-top:var(--s3);">
          <summary>Opciones avanzadas</summary>
          <div class="grid" style="grid-template-columns: repeat(3, 1fr); margin-top:var(--s3);">
            <label title="% extra aplicado al coste">Markup materiales (%) <input id="markup" class="input" type="number" placeholder="20" step="1"></label>
            <label title="Impuesto sobre el valor a√±adido">IVA (%) <input id="vat" class="input" type="number" placeholder="21" step="1"></label>
            <label title="Coste por kil√≥metro recorrido">Coste desplazamiento (‚Ç¨/km) <input id="travelKm" class="input" type="number" placeholder="0.5" step="0.1"></label>
          </div>
        </details>
      </div>

      <div class="toolbar" style="justify-content:flex-end; margin-top: var(--s3);">
        <button id="btnSaveTariffs" class="btn primary">Guardar</button>
      </div>
    </article>

    <!-- Proveedores -->
    <article id="proveedor" class="card">
      <h3>üõí Proveedores</h3>
      <div class="row">
        <label class="w240">
          <span>Proveedor por defecto</span>
          <select id="provider" class="input">
            <option value="Bricomart">Bricomart</option>
            <option value="Leroy Merlin">Leroy Merlin</option>
            <option value="Amazon Business">Amazon Business</option>
            <option value="other">Otro (manual)</option>
          </select>
        </label>

        <label class="w240" id="otherProviderWrap" style="display:none;">
          <span>Nombre proveedor</span>
          <input id="otherProvider" class="input" placeholder="Nombre"/>
        </label>

        <div class="w240">
          <span>Subir cat√°logo</span>
          <label id="catalogDrop" class="drop-zone">Arrastra o haz clic<input id="providerCatalog" type="file"></label>
          <div id="catalogFileStatus" class="upload-status"></div>
        </div>

        <button id="btnUploadCatalog" class="btn secondary">Subir archivo</button>

        <div class="inline">
          <span>Estado:</span>
          <span id="catalogStatus" class="badge idle">Sin subir</span>
        </div>
      </div>
      <div class="toolbar" style="justify-content:flex-end; margin-top: var(--s3);">
        <button id="btnSaveProvider" class="btn primary">Guardar</button>
      </div>
    </article>

    <!-- Documentaci√≥n y prefijos -->
    <article id="prefijos" class="card">
      <h3>üìë Documentaci√≥n y prefijos</h3>
      <div class="grid" style="grid-template-columns: repeat(3, 1fr);">
        <label>Presupuestos <input id="prefQuote" class="input" placeholder="PRES-2025-"/></label>
        <label>Facturas <input id="prefInvoice" class="input" placeholder="FACT-"/></label>
        <label>Partes <input id="prefWork" class="input" placeholder="PAR-"/></label>
      </div>
      <details class="advanced" style="margin-top:var(--s3);">
        <summary>Opciones avanzadas</summary>
        <div class="grid" style="grid-template-columns: repeat(3, 1fr); margin-top:var(--s3);">
          <label>Reset contador Presupuestos <input id="resetQuote" class="input" type="number" placeholder="1"/></label>
          <label>Reset contador Facturas <input id="resetInvoice" class="input" type="number" placeholder="1"/></label>
          <label>Reset contador Partes <input id="resetWork" class="input" type="number" placeholder="1"/></label>
        </div>
      </details>
      <p class="hint">El siguiente n√∫mero se recalcular√° autom√°ticamente al guardar.</p>
      <div class="toolbar" style="justify-content:flex-end;">
        <button id="btnSavePrefixes" class="btn primary">Guardar</button>
      </div>
    </article>

    <!-- Datos fiscales -->
    <article id="fiscal" class="card">
      <h3>üßæ Datos fiscales</h3>
      <div class="grid" style="grid-template-columns: repeat(2, 1fr);">
        <label>Nombre fiscal <input id="taxName" class="input" /></label>
        <label>NIF/CIF <input id="taxId" class="input" /></label>
        <label>Direcci√≥n <input id="taxAddress" class="input" placeholder="C/ Mayor 123, Madrid"/></label>
        <label>Ciudad / CP <input id="taxCityZip" class="input" placeholder="Madrid, 28080"/></label>
      </div>
      <div class="toolbar" style="justify-content:flex-end;">
        <button id="btnSaveFiscal" class="btn primary">Guardar</button>
      </div>
    </article>

    <!-- Branding -->
    <article id="branding" class="card">
      <h3>üé® Branding de documentos</h3>
      <div class="grid" style="grid-template-columns: 1fr 1fr;">
        <div class="wire" style="padding:12px;">
          <span>Logo</span>
          <label id="logoDrop" class="drop-zone" style="margin-top:.6rem;">Arrastra o haz clic<input id="logoFile" type="file" accept="image/*"></label>
          <div id="logoPreview" class="preview-box" style="margin-top:.6rem;">
            <span>Vista previa</span>
          </div>
        </div>
        <div>
          <label>Modelo de factura</label>
          <select id="tplInvoice" class="input">
            <option value="A">Modelo A</option>
            <option value="B">Modelo B</option>
          </select>
          <label style="margin-top:.6rem;">Modelo de presupuesto</label>
          <select id="tplQuote" class="input">
            <option value="A">Modelo A</option>
            <option value="B">Modelo B</option>
          </select>
          <div class="toolbar" style="justify-content:flex-end; margin-top: var(--s3);">
            <button id="btnSaveBranding" class="btn primary">Guardar</button>
            <button id="btnPreviewBrand" class="btn secondary">Preview</button>
          </div>
        </div>
      </div>
    </article>

    <!-- Modelo de email -->
    <article id="email" class="card">
      <h3>‚úâÔ∏è Modelo de email</h3>
      <label>Asunto <input id="emailSubject" class="input" style="font-family:monospace;" placeholder="Tu presupuesto {numero}"/></label>
      <label style="margin-top:.6rem;">Cuerpo</label>
      <textarea id="emailBody" class="input" style="height:140px; font-family:monospace;" placeholder="Hola {cliente}, adjuntamos tu presupuesto por importe {importe}. Enlace: {enlace}"></textarea>
      <div id="emailPreview" class="preview-box" style="margin-top:var(--s3);"></div>
      <div class="toolbar" style="justify-content:flex-end; margin-top: var(--s3);">
        <button id="btnSaveEmail" class="btn primary">Guardar</button>
      </div>
      <span class="muted" title="{cliente}, {importe}, {enlace}, {numero}" style="font-size:.85rem;">‚ÑπÔ∏è Variables disponibles</span>
    </article>

  </section>
</main>

<!--#include "partials/footer.html" -->

<div id="toast" class="toast"></div>

<script>
const API = location.origin.replace(/\/$/, ''); // adjust if FE+BE on different hosts

// toast helper
const toastBox = document.getElementById('toast');
function toast(msg){
  toastBox.textContent = msg;
  toastBox.classList.add('show');
  setTimeout(()=>toastBox.classList.remove('show'), 2000);
}

// Format minutes as m' or h h'
function fmtMinutes(m){
  if(m < 60) return `${m}'`;
  const h = Math.floor(m/60);
  const min = m % 60;
  return min ? `${h}h ${min}'` : `${h}h`;
}

// Build segmented controls
function buildSegmented(id, values, def){
  const cont=document.getElementById(id);
  cont.innerHTML = values.map(v=>`<label><input type="radio" name="${id}" value="${v}"><span>${fmtMinutes(v)}</span></label>`).join('');
  const defInput = cont.querySelector(`input[value="${def}"]`) || cont.querySelector('input');
  if(defInput) defInput.checked = true;
}

buildSegmented('minBlock',[5,10,15,30,60],30);
buildSegmented('stepBlock',[5,10,15,30,60],30);

// drop zones
const aiFiles = document.getElementById('aiFiles');
const catalogInput = document.getElementById('providerCatalog');
const logoFile = document.getElementById('logoFile');
const aiFileStatus = document.getElementById('aiFileStatus');
const catalogFileStatus = document.getElementById('catalogFileStatus');

function bindDropZone(zone, input){
  zone.addEventListener('click', () => input.click());
  zone.addEventListener('dragover', e => { e.preventDefault(); zone.classList.add('hover'); });
  zone.addEventListener('dragleave', () => zone.classList.remove('hover'));
  zone.addEventListener('drop', e => { e.preventDefault(); input.files = e.dataTransfer.files; zone.classList.remove('hover'); input.dispatchEvent(new Event('change')); });
}

const aiDrop = document.getElementById('aiDrop');
bindDropZone(aiDrop, aiFiles);
aiFiles.addEventListener('change', () => {
  aiDrop.textContent = aiFiles.files.length ? `${aiFiles.files.length} archivo(s)` : 'Arrastra o haz clic';
  aiFileStatus.textContent = aiFiles.files.length ? [...aiFiles.files].map(f=>`‚è≥ ${f.name}`).join(', ') : '';
});

const catalogDrop = document.getElementById('catalogDrop');
bindDropZone(catalogDrop, catalogInput);
catalogInput.addEventListener('change', () => {
  const f = catalogInput.files[0];
  catalogDrop.textContent = f?.name || 'Arrastra o haz clic';
  catalogFileStatus.textContent = f ? `‚è≥ ${f.name}` : '';
});

const logoDrop = document.getElementById('logoDrop');
bindDropZone(logoDrop, logoFile);

// Provider "other"
const provider = document.getElementById('provider');
const otherWrap = document.getElementById('otherProviderWrap');
provider.addEventListener('change', () => {
  otherWrap.style.display = provider.value === 'other' ? '' : 'none';
});

// Branding preview
const logoPreview = document.getElementById('logoPreview');
logoFile.addEventListener('change', () => {
  logoDrop.textContent = logoFile.files[0]?.name || 'Arrastra o haz clic';
  const f = logoFile.files[0]; if(!f) return;
  const reader = new FileReader();
  reader.onload = e => {
    logoPreview.innerHTML = `<img src="${e.target.result}" alt="logo" style="max-width:100%; max-height:120px; object-fit:contain;">`;
  };
  reader.readAsDataURL(f);
});

// ---- IA actions
const aiUploaded = document.getElementById('aiUploaded');
const btnUploadAI = document.getElementById('btnUploadAI');
const btnTrain = document.getElementById('btnTrain');
const btnResetAI = document.getElementById('btnResetAI');
const btnDownloadModel = document.getElementById('btnDownloadModel');
const aiStatus = document.getElementById('aiStatus');
const trainHint = document.getElementById('trainHint');
const catalogStatus = document.getElementById('catalogStatus');

btnUploadAI.onclick = async () => {
  const fd = new FormData();
  [...aiFiles.files].forEach(f => fd.append('files', f));
  const r = await fetch(`${API}/settings/ai/uploads`, { method:'POST', body: fd });
  const j = await r.json();
  aiUploaded.textContent = j.count ?? 0;
  aiFileStatus.textContent = [...aiFiles.files].map(f=>`‚úÖ ${f.name}`).join(', ');
  toast('Archivos subidos');
};

btnTrain.onclick = async () => {
  trainHint.style.display = '';
  btnTrain.disabled = true;
  const r = await fetch(`${API}/settings/ai/train`, { method:'POST' });
  const j = await r.json().catch(()=>({}));
  aiStatus.className='badge pending';
  aiStatus.textContent='Procesando‚Ä¶';
  setTimeout(async () => { // poll once for MVP
    const rr = await fetch(`${API}/settings/ai/status`);
    const jj = await rr.json();
    if(jj.status === 'error'){
      aiStatus.className='badge error';
      aiStatus.textContent='Error';
    } else {
      aiStatus.className='badge ok';
      aiStatus.textContent='Completado';
    }
    trainHint.style.display = 'none';
    btnTrain.disabled = false;
  }, 2500);
};

btnResetAI.onclick = async () => {
  await fetch(`${API}/settings/ai/reset`, { method:'POST' });
  aiUploaded.textContent = '0';
  aiStatus.className='badge idle';
  aiStatus.textContent='Sin entrenar';
};

btnDownloadModel.onclick = () => { window.location = `${API}/settings/ai/model`; };

// ---- SAVE handlers
async function saveJSON(url, payload, msg){
  const r = await fetch(url, {
    method:'PUT',
    headers:{ 'Content-Type':'application/json' },
    body: JSON.stringify(payload)
  });
  if(!r.ok){ toast('Error guardando'); return; }
  toast(msg || 'Guardado');
}

document.getElementById('btnSaveTariffs').onclick = () => saveJSON(`${API}/settings/tariffs`, {
  rate_hour: +document.getElementById('rateHour').value,
  min_minutes: +document.querySelector('#minBlock input:checked').value,
  step_minutes: +document.querySelector('#stepBlock input:checked').value,
  markup_percent: +document.getElementById('markup').value,
  vat_percent: +document.getElementById('vat').value,
  travel_per_km: +document.getElementById('travelKm').value
}, 'Tarifas guardadas correctamente');

document.getElementById('btnSaveProvider').onclick = async () => {
  const chosen = provider.value === 'other' ? document.getElementById('otherProvider').value : provider.value;
  await saveJSON(`${API}/settings/provider`, { default_provider: chosen }, 'Proveedor guardado');
};

document.getElementById('btnUploadCatalog').onclick = async () => {
  const fd = new FormData();
  const file = catalogInput.files[0];
  if(!file) return toast('Selecciona un archivo');
  fd.append('file', file);
  catalogStatus.className='badge pending';
  catalogStatus.textContent='Procesando‚Ä¶';
  const r = await fetch(`${API}/settings/provider/catalog`, { method:'POST', body: fd });
  const j = await r.json();
  if(j.status === 'error'){
    catalogStatus.className='badge error';
    catalogStatus.textContent='Error';
    catalogFileStatus.textContent = `‚ùå ${file.name}`;
  } else {
    catalogStatus.className='badge ok';
    catalogStatus.textContent='Procesado';
    catalogFileStatus.textContent = `‚úÖ ${file.name}`;
    toast('Cat√°logo subido');
  }
};

document.getElementById('btnSavePrefixes').onclick = () => saveJSON(`${API}/settings/prefixes`, {
  quote_prefix: document.getElementById('prefQuote').value,
  invoice_prefix: document.getElementById('prefInvoice').value,
  work_prefix: document.getElementById('prefWork').value,
  reset: {
    quote_next: +document.getElementById('resetQuote').value || null,
    invoice_next: +document.getElementById('resetInvoice').value || null,
    work_next: +document.getElementById('resetWork').value || null
  }
}, 'Prefijos guardados');

document.getElementById('btnSaveFiscal').onclick = () => saveJSON(`${API}/settings/fiscal`, {
  legal_name: document.getElementById('taxName').value,
  tax_id: document.getElementById('taxId').value,
  address: document.getElementById('taxAddress').value,
  city_zip: document.getElementById('taxCityZip').value
}, 'Datos fiscales guardados');

document.getElementById('btnSaveBranding').onclick = async () => {
  // upload logo if selected
  const lf = document.getElementById('logoFile').files[0];
  if(lf){
    const fd = new FormData(); fd.append('file', lf);
    await fetch(`${API}/settings/branding/logo`, { method:'POST', body: fd });
  }
  await saveJSON(`${API}/settings/branding`, {
    invoice_template: document.getElementById('tplInvoice').value,
    quote_template: document.getElementById('tplQuote').value
  }, 'Branding guardado');
};

document.getElementById('btnPreviewBrand').onclick = () => window.open(`${API}/settings/branding/preview`, '_blank');

document.getElementById('btnSaveEmail').onclick = () => saveJSON(`${API}/settings/email-template`, {
  subject: document.getElementById('emailSubject').value,
  body: document.getElementById('emailBody').value
}, 'Modelo de email guardado');

const emailSubject = document.getElementById('emailSubject');
const emailBody = document.getElementById('emailBody');
const emailPreview = document.getElementById('emailPreview');
function renderEmail(){
  const subj = emailSubject.value.replace('{numero}','PRES-2025');
  const body = emailBody.value
    .replace('{cliente}','Juan')
    .replace('{importe}','450‚Ç¨')
    .replace('{enlace}','fixhub.com/presupuesto/2025')
    .replace('{numero}','PRES-2025');
  emailPreview.innerHTML = `<strong>${subj}</strong><p>${body}</p>`;
}
emailSubject.addEventListener('input', renderEmail);
emailBody.addEventListener('input', renderEmail);
renderEmail();

// ---- Load initial values
(async function boot(){
  try{
    const r = await fetch(`${API}/settings`);
    if(!r.ok) return;
    const s = await r.json();

    // Map settings to fields (all optional)
    document.getElementById('rateHour').value = s.tariffs?.rate_hour ?? '';
    const mb = document.querySelector(`#minBlock input[value="${s.tariffs?.min_minutes ?? 30}"]`);
    if(mb) mb.checked = true;
    const sb = document.querySelector(`#stepBlock input[value="${s.tariffs?.step_minutes ?? 30}"]`);
    if(sb) sb.checked = true;
    document.getElementById('markup').value = s.tariffs?.markup_percent ?? '';
    document.getElementById('vat').value = s.tariffs?.vat_percent ?? '';
    document.getElementById('travelKm').value = s.tariffs?.travel_per_km ?? '';

    if(s.provider?.default_provider){
      if(['Bricomart','Leroy Merlin','Amazon Business'].includes(s.provider.default_provider)){
        provider.value = s.provider.default_provider;
        otherWrap.style.display='none';
      } else {
        provider.value = 'other';
        otherWrap.style.display='';
        document.getElementById('otherProvider').value = s.provider.default_provider;
      }
    }

    document.getElementById('prefQuote').value = s.prefixes?.quote_prefix ?? '';
    document.getElementById('prefInvoice').value = s.prefixes?.invoice_prefix ?? '';
    document.getElementById('prefWork').value = s.prefixes?.work_prefix ?? '';

    document.getElementById('taxName').value = s.fiscal?.legal_name ?? '';
    document.getElementById('taxId').value = s.fiscal?.tax_id ?? '';
    document.getElementById('taxAddress').value = s.fiscal?.address ?? '';
    document.getElementById('taxCityZip').value = s.fiscal?.city_zip ?? '';

    document.getElementById('tplInvoice').value = s.branding?.invoice_template ?? 'A';
    document.getElementById('tplQuote').value = s.branding?.quote_template ?? 'A';

    document.getElementById('emailSubject').value = s.email_template?.subject ?? '';
    document.getElementById('emailBody').value = s.email_template?.body ?? '';
    renderEmail();
  }catch(e){ /* noop */ }
})();
</script>
</body>
</html>
