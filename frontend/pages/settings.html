<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>FixHub · Configuración</title>
  <!--#include "partials/tailwind.html" -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" integrity="sha512-pIVp9sPu0YdHDi3uL1l5X8GZFODdgNpTi27C1l2qCkCmZJLdnOjFkWDXLI4YAlnXrhIR3IuAeGHGZk+y3OC/qw==" crossorigin="anonymous" referrerpolicy="no-referrer" />
</head>
<body>
<!--#include "partials/header.html" -->

<main class="page-container grid gap-6">
  <section class="card">
    <h1 class="section-heading text-3xl">Configuración</h1>
    <p class="muted">Entrena la IA, ajusta tarifas, gestiona proveedores y personaliza documentos desde este panel.</p>
  </section>

  <section class="card grid gap-4" id="ia">
    <div class="section-head">
      <h2 class="text-xl font-semibold text-ink">IA y presets</h2>
      <span class="hint-right">Sube mínimo 3 presupuestos previos</span>
    </div>
    <div class="row">
      <label class="w240">
        <span>Subir archivo(s)</span>
        <input id="aiFiles" type="file" multiple />
      </label>
      <button id="btnUploadAI" class="btn secondary">Subir archivo</button>
      <div class="inline">
        <span>Subidos</span><strong id="aiUploaded">0</strong>
        <label class="inline">Estado:
          <span id="aiStatus" class="badge idle">—</span>
        </label>
      </div>
      <div class="toolbar-right">
        <button id="btnTrain" class="btn secondary"><span class="chip">⚙️</span> Entrenar IA</button>
        <button id="btnResetAI" class="btn gray">Resetear</button>
        <button id="btnDownloadModel" class="btn dark">Descargar modelo</button>
      </div>
    </div>
    <div id="trainHint" class="hint hidden">Entrenando… <span class="spinner"></span></div>
  </section>

  <section class="card grid gap-4" id="tarifas">
    <h2 class="text-xl font-semibold text-ink">Tarifas y márgenes</h2>
    <div class="grid gap-4 md:grid-cols-3">
      <label>€/hora <input id="rateHour" class="input" type="number" placeholder="45" step="1"></label>
      <label>Mínimo computable
        <select id="minBlock" class="input"></select>
      </label>
      <label>Escalado de tiempo
        <select id="stepBlock" class="input"></select>
      </label>
      <label>Markup materiales (%) <input id="markup" class="input" type="number" placeholder="20" step="1"></label>
      <label>IVA (%) <input id="vat" class="input" type="number" placeholder="21" step="1"></label>
      <label>Coste desplazamiento (€/km) <input id="travelKm" class="input" type="number" placeholder="0.5" step="0.1"></label>
    </div>
    <div class="toolbar justify-end">
      <button id="btnSaveTariffs" class="btn gray">Guardar</button>
    </div>
  </section>

  <section class="card grid gap-4" id="proveedor">
    <h2 class="text-xl font-semibold text-ink">Proveedores</h2>
    <div class="row">
      <label class="w240">
        <span>Proveedor por defecto</span>
        <select id="provider" class="input">
          <option value="Bricomart">Bricomart</option>
          <option value="Leroy Merlin">Leroy Merlin</option>
          <option value="Amazon Business">Amazon Business</option>
          <option value="other">Otro (manual)</option>
        </select>
      </label>
      <label class="w240 hidden" id="otherProviderWrap">
        <span>Nombre proveedor</span>
        <input id="otherProvider" class="input" placeholder="Nombre" />
      </label>
      <label class="w240">
        <span>Subir catálogo</span>
        <input id="providerCatalog" type="file" />
      </label>
      <button id="btnUploadCatalog" class="btn gray">Subir archivo</button>
      <div class="inline">
        <span>Estado:</span>
        <input id="catalogStatus" class="input max-w-[160px]" value="procesando..." />
      </div>
      <div class="toolbar-right">
        <button id="btnSaveProvider" class="btn gray">Guardar</button>
      </div>
    </div>
  </section>

  <section class="card grid gap-4" id="prefijos">
    <h2 class="text-xl font-semibold text-ink">Documentación y prefijos</h2>
    <div class="grid gap-4 md:grid-cols-2">
      <div class="grid gap-3 md:grid-cols-3">
        <label>Presupuestos <input id="prefQuote" class="input" placeholder="PRES-2025-"/></label>
        <label>Facturas <input id="prefInvoice" class="input" placeholder="FACT-"/></label>
        <label>Partes <input id="prefWork" class="input" placeholder="PAR-"/></label>
      </div>
      <div class="grid gap-3 md:grid-cols-3">
        <label>Reset contador Presupuestos <input id="resetQuote" class="input" type="number" placeholder="1"/></label>
        <label>Reset contador Facturas <input id="resetInvoice" class="input" type="number" placeholder="1"/></label>
        <label>Reset contador Partes <input id="resetWork" class="input" type="number" placeholder="1"/></label>
      </div>
    </div>
    <p class="hint">El siguiente número se recalculará automáticamente al guardar.</p>
    <div class="toolbar justify-end">
      <button id="btnSavePrefixes" class="btn gray">Guardar</button>
    </div>
  </section>

  <section class="card grid gap-4" id="fiscal">
    <h2 class="text-xl font-semibold text-ink">Datos fiscales</h2>
    <div class="grid gap-4 md:grid-cols-2">
      <label>Nombre fiscal <input id="taxName" class="input" /></label>
      <label>NIF/CIF <input id="taxId" class="input" /></label>
      <label>Dirección <input id="taxAddress" class="input" /></label>
      <label>Ciudad / CP <input id="taxCityZip" class="input" /></label>
      <label>Admin Email <input id="admnEmail" class="input" /></label>
      <label>Admin Tlf <input id="admntlf" class="input" /></label>
    </div>
    <div class="toolbar justify-end">
      <button id="btnSaveFiscal" class="btn gray">Guardar</button>
    </div>
  </section>

  <section class="card grid gap-4" id="branding">
    <h2 class="text-xl font-semibold text-ink">Branding de documentos</h2>
    <div class="grid gap-4 md:grid-cols-2">
      <div class="wire">
        <label>Logo <input id="logoFile" type="file" accept="image/*"/></label>
        <div id="logoPreview" class="preview-box mt-3">
          <span>Vista previa</span>
        </div>
      </div>
      <div class="grid gap-3">
        <label>Modelo de factura
          <select id="tplInvoice" class="input">
            <option value="A">Modelo A</option>
            <option value="B">Modelo B</option>
          </select>
        </label>
        <label>Modelo de presupuesto
          <select id="tplQuote" class="input">
            <option value="A">Modelo A</option>
            <option value="B">Modelo B</option>
          </select>
        </label>
        <div class="toolbar justify-end">
          <button id="btnSaveBranding" class="btn gray">Guardar</button>
          <button id="btnPreviewBrand" class="btn secondary">Preview</button>
        </div>
      </div>
    </div>
  </section>

  <section class="card grid gap-4" id="email">
    <h2 class="text-xl font-semibold text-ink">Modelo de email</h2>
    <label>Asunto <input id="emailSubject" class="input" placeholder="Tu presupuesto {numero}"/></label>
    <label>Cuerpo</label>
    <textarea id="emailBody" class="input" placeholder="Hola {cliente}, adjuntamos tu {tipoDocumento} por importe {importe}. Enlace: {enlace}"></textarea>
    <div class="toolbar justify-end">
      <button id="btnSaveEmail" class="btn gray">Guardar</button>
    </div>
    <p class="hint">Variables disponibles: {cliente}, {importe}, {tipoDocumento}, {enlace}, {numero}.</p>
  </section>
</main>

<!--#include "partials/footer.html" -->

<script>
function fillSteps(sel){
  sel.innerHTML='';
  for(let m=5;m<=120;m+=5){
    const o=document.createElement('option');
    o.value=m; o.textContent=`${m}'`;
    sel.appendChild(o);
  }
}

const minBlock = document.getElementById('minBlock');
const stepBlock = document.getElementById('stepBlock');
fillSteps(minBlock); fillSteps(stepBlock);

const provider = document.getElementById('provider');
const otherWrap = document.getElementById('otherProviderWrap');
provider.addEventListener('change', () => {
  otherWrap.classList.toggle('hidden', provider.value !== 'other');
});

const logoFile = document.getElementById('logoFile');
const logoPreview = document.getElementById('logoPreview');
logoFile.addEventListener('change', () => {
  const f = logoFile.files[0]; if(!f) return;
  const reader = new FileReader();
  reader.onload = e => {
    logoPreview.innerHTML = `<img src="${e.target.result}" alt="logo" class="max-h-32 w-auto">`;
  };
  reader.readAsDataURL(f);
});

function renderAIStatus(status){
  const el = document.getElementById('aiStatus');
  const map = {
    idle: {text:'Idle', cls:'idle'},
    processing: {text:'Procesando…', cls:'processing'},
    ok: {text:'OK', cls:'ok'},
    error: {text:'Error', cls:'error'}
  };
  const m = map[status] || map.idle;
  el.className = `badge ${m.cls}`;
  if (status === 'processing') {
    el.innerHTML = `<span class="spinner"></span> ${m.text}`;
  } else {
    el.textContent = m.text;
  }
}

const aiFiles = document.getElementById('aiFiles');
const aiUploaded = document.getElementById('aiUploaded');
const btnUploadAI = document.getElementById('btnUploadAI');
const btnTrain = document.getElementById('btnTrain');
const btnResetAI = document.getElementById('btnResetAI');
const btnDownloadModel = document.getElementById('btnDownloadModel');
const aiStatus = document.getElementById('aiStatus');
const trainHint = document.getElementById('trainHint');

btnUploadAI.onclick = async () => {
  const fd = new FormData();
  [...aiFiles.files].forEach(f => fd.append('files', f));
  const r = await fetch(`/api-v1/settings/ai/uploads`, { method:'POST', body: fd });
  const j = await r.json();
  aiUploaded.textContent = j.count ?? 0;
};

btnTrain.onclick = async () => {
  trainHint.classList.remove('hidden');
  btnTrain.disabled = true;
  const r = await fetch(`/api-v1/settings/ai/train`, { method:'POST' });
  const j = await r.json().catch(()=>({}));
  renderAIStatus(j.status || 'processing');
  setTimeout(async () => {
    const rr = await fetch(`/api-v1/settings/ai/status`);
    const jj = await rr.json();
    renderAIStatus(jj.status || 'ok');
    trainHint.classList.add('hidden');
    btnTrain.disabled = false;
  }, 2500);
};

btnResetAI.onclick = async () => {
  await fetch(`/api-v1/settings/ai/reset`, { method:'POST' });
  aiUploaded.textContent = '0';
  renderAIStatus('idle');
};

btnDownloadModel.onclick = () => { window.location = `/api-v1/settings/ai/model`; };

async function saveJSON(url, payload){
  const r = await fetch(url, {
    method:'PUT',
    headers:{ 'Content-Type':'application/json' },
    body: JSON.stringify(payload)
  });
  if(!r.ok){ alert('Error guardando'); return; }
}

document.getElementById('btnSaveTariffs').onclick = () => saveJSON(`/api-v1/settings/tariffs`, {
  rate_hour: +document.getElementById('rateHour').value,
  min_minutes: +document.getElementById('minBlock').value,
  step_minutes: +document.getElementById('stepBlock').value,
  markup_percent: +document.getElementById('markup').value,
  vat_percent: +document.getElementById('vat').value,
  travel_per_km: +document.getElementById('travelKm').value
});

document.getElementById('btnSaveProvider').onclick = async () => {
  const chosen = provider.value === 'other' ? document.getElementById('otherProvider').value : provider.value;
  await saveJSON(`/api-v1/settings/provider`, { default_provider: chosen });
};

document.getElementById('btnUploadCatalog').onclick = async () => {
  const fd = new FormData();
  const file = document.getElementById('providerCatalog').files[0];
  if(!file) return alert('Selecciona un archivo');
  fd.append('file', file);
  const r = await fetch(`/api-v1/settings/provider/catalog`, { method:'POST', body: fd });
  const j = await r.json();
  document.getElementById('catalogStatus').value = j.status || 'procesado';
};

document.getElementById('btnSavePrefixes').onclick = () => saveJSON(`/api-v1/settings/prefixes`, {
  quote_prefix: document.getElementById('prefQuote').value,
  invoice_prefix: document.getElementById('prefInvoice').value,
  work_prefix: document.getElementById('prefWork').value,
  reset: {
    quote_next: +document.getElementById('resetQuote').value || null,
    invoice_next: +document.getElementById('resetInvoice').value || null,
    work_next: +document.getElementById('resetWork').value || null
  }
});

document.getElementById('btnSaveFiscal').onclick = () => saveJSON(`/api-v1/settings/fiscal`, {
  legal_name: document.getElementById('taxName').value,
  tax_id: document.getElementById('taxId').value,
  address: document.getElementById('taxAddress').value,
  city_zip: document.getElementById('taxCityZip').value
});

document.getElementById('btnSaveBranding').onclick = async () => {
  const lf = document.getElementById('logoFile').files[0];
  if(lf){
    const fd = new FormData(); fd.append('file', lf);
    await fetch(`/api-v1/settings/branding/logo`, { method:'POST', body: fd });
  }
  await saveJSON(`/api-v1/settings/branding`, {
    invoice_template: document.getElementById('tplInvoice').value,
    quote_template: document.getElementById('tplQuote').value
  });
};

document.getElementById('btnPreviewBrand').onclick = () => window.open(`/api-v1/settings/branding/preview`, '_blank');

document.getElementById('btnSaveEmail').onclick = () => saveJSON(`/api-v1/settings/email-template`, {
  subject: document.getElementById('emailSubject').value,
  body: document.getElementById('emailBody').value
});

(async function boot(){
  try{
    const r = await fetch(`/api-v1/settings`);
    if(!r.ok) return;
    const s = await r.json();
    document.getElementById('rateHour').value = s.tariffs?.rate_hour ?? '';
    document.getElementById('minBlock').value = s.tariffs?.min_minutes ?? 5;
    document.getElementById('stepBlock').value = s.tariffs?.step_minutes ?? 5;
    document.getElementById('markup').value = s.tariffs?.markup_percent ?? '';
    document.getElementById('vat').value = s.tariffs?.vat_percent ?? '';
    document.getElementById('travelKm').value = s.tariffs?.travel_per_km ?? '';
    if (s.provider?.default_provider) {
      provider.value = s.provider.default_provider;
      provider.dispatchEvent(new Event('change'));
      if (provider.value === 'other') {
        document.getElementById('otherProvider').value = s.provider.default_provider;
      }
    }
    document.getElementById('catalogStatus').value = s.provider?.catalog_status || '—';
    document.getElementById('prefQuote').value = s.prefixes?.quote_prefix ?? '';
    document.getElementById('prefInvoice').value = s.prefixes?.invoice_prefix ?? '';
    document.getElementById('prefWork').value = s.prefixes?.work_prefix ?? '';
    document.getElementById('taxName').value = s.fiscal?.legal_name ?? '';
    document.getElementById('taxId').value = s.fiscal?.tax_id ?? '';
    document.getElementById('taxAddress').value = s.fiscal?.address ?? '';
    document.getElementById('taxCityZip').value = s.fiscal?.city_zip ?? '';
    document.getElementById('emailSubject').value = s.email?.subject ?? '';
    document.getElementById('emailBody').value = s.email?.body ?? '';
    renderAIStatus(s.ai?.status || 'idle');
    aiUploaded.textContent = s.ai?.uploads ?? 0;
  } catch(e){
    console.warn('No se pudo cargar la configuración inicial', e);
  }
})();
</script>
</body>
</html>
