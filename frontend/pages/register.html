<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>FixHub · Crear cuenta</title>
  <!--#include "partials/tailwind.html" -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" integrity="sha512-pIVp9sPu0YdHDi3uL1l5X8GZFODdgNpTi27C1l2qCkCmZJLdnOjFkWDXLI4YAlnXrhIR3IuAeGHGZk+y3OC/qw==" crossorigin="anonymous" referrerpolicy="no-referrer" />
</head>
<body>
<!--#include "partials/header.html" -->

<main class="page-container">
  <header class="flex flex-col gap-2">
    <h1 class="section-heading">Crear tu cuenta</h1>
    <p class="muted">Selecciona el plan que necesitas y completa los datos básicos para empezar a trabajar con FixHub.</p>
  </header>

  <form id="signupForm" class="grid gap-6" novalidate>
    <fieldset class="grid gap-3">
      <legend class="text-sm font-semibold uppercase tracking-wide text-slate-500">Plan <span class="chip">* requerido</span></legend>
      <div class="flex flex-wrap items-center gap-4" role="group" aria-label="Seleccionar plan">
        <label class="input-inline"><input type="radio" name="plan" value="Trial" checked> Trial</label>
        <label class="input-inline"><input type="radio" name="plan" value="Solo"> Solo</label>
        <label class="input-inline"><input type="radio" name="plan" value="Team"> Team</label>
        <div id="teamSeatsWrap" class="input-inline hidden">
          <span>Personas:</span>
          <select id="teamSeats" class="input max-w-[140px]" name="team_seats">
            <option value="2">2</option>
            <option value="3" selected>3</option>
            <option value="4">4</option>
            <option value="5">5</option>
            <option value="6">6</option>
            <option value="7">7</option>
            <option value="8">8+</option>
          </select>
        </div>
      </div>
      <p class="hint">En planes <strong>Solo</strong> o <strong>Team</strong> pediremos documentación fiscal.</p>
    </fieldset>

    <div class="grid gap-4 md:grid-cols-2">
      <label for="email">Email *</label>
      <input id="email" name="email" type="email" class="input" required />
      <label for="phone">Teléfono *</label>
      <input id="phone" name="phone" type="tel" class="input" required />
    </div>

    <div class="grid gap-4 md:grid-cols-2">
      <label for="name">Nombre *</label>
      <input id="name" name="name" class="input" required />
      <label for="surname1">Primer apellido *</label>
      <input id="surname1" name="surname1" class="input" required />
    </div>

    <div class="grid gap-4 md:grid-cols-2">
      <label for="surname2">Segundo apellido *</label>
      <input id="surname2" name="surname2" class="input" required />
      <div id="nifWrap" class="hidden">
        <label for="nif">NIF / DNI / NIE *</label>
        <input id="nif" name="nif" class="input" />
      </div>
    </div>

    <div class="grid gap-3">
      <label for="password">Contraseña *</label>
      <input id="password" name="password" type="password" class="input" required minlength="8" placeholder="Mínimo 8 caracteres" />
      <div class="pw-meter"><span id="pwBar" class="pw-w1"></span></div>
      <p id="pwMsg" class="hint">Usa mayúsculas, minúsculas, números y símbolos.</p>
    </div>

    <label for="password_confirm">Repetir contraseña *</label>
    <input id="password_confirm" name="password_confirm" type="password" class="input" required minlength="8" placeholder="Repite la contraseña" />

    <div class="grid gap-4 md:grid-cols-2">
      <label for="company">Empresa / Nombre comercial</label>
      <input id="company" name="company" class="input" placeholder="Opcional" />
      <label for="sector">Sector / Industria *</label>
      <select id="sector" name="sector" class="input" required>
        <option value="" disabled selected>Selecciona sector</option>
        <option>Electricidad</option>
        <option>Fontanería</option>
        <option>Climatización</option>
        <option>Mantenimiento</option>
        <option>Pintura / Reformas</option>
        <option value="Otro">Otro…</option>
      </select>
    </div>
    <div id="sectorOtherWrap" class="hidden">
      <label for="sector_other">Especifica tu sector *</label>
      <input id="sector_other" name="sector_other" class="input" placeholder="Describe tu actividad" />
    </div>

    <div class="grid gap-4 md:grid-cols-3">
      <label for="country">País *</label>
      <select id="country" name="country" class="input" required>
        <option value="ES" selected>España</option>
        <option value="PT">Portugal</option>
        <option value="FR">Francia</option>
        <option value="IT">Italia</option>
      </select>
      <label for="region">Provincia *</label>
      <select id="region" name="region" class="input" required>
        <option value="" disabled selected></option>
        <option>A Coruña</option><option>Albacete</option><option>Alicante</option><option>Almería</option><option>Álava</option>
        <option>Asturias</option><option>Ávila</option><option>Badajoz</option><option>Barcelona</option><option>Bizkaia</option>
        <option>Burgos</option><option>Cáceres</option><option>Cádiz</option><option>Cantabria</option><option>Castellón</option>
        <option>Ciudad Real</option><option>Córdoba</option><option>Cuenca</option><option>Gipuzkoa</option><option>Girona</option>
        <option>Granada</option><option>Guadalajara</option><option>Huelva</option><option>Huesca</option><option>Illes Balears</option>
        <option>Jaén</option><option>La Rioja</option><option>Las Palmas</option><option>León</option><option>Lleida</option><option>Lugo</option>
        <option>Madrid</option><option>Málaga</option><option>Murcia</option><option>Navarra</option><option>Ourense</option>
        <option>Palencia</option><option>Pontevedra</option><option>Salamanca</option><option>Santa Cruz de Tenerife</option>
        <option>Segovia</option><option>Sevilla</option><option>Soria</option><option>Tarragona</option><option>Teruel</option>
        <option>Toledo</option><option>València</option><option>Valladolid</option><option>Zamora</option><option>Zaragoza</option>
      </select>
      <label for="zip">Código Postal</label>
      <input id="zip" name="zip" class="input" inputmode="numeric" pattern="[0-9]{5}" placeholder="00000" />
    </div>

    <label class="input-inline">
      <input type="checkbox" id="terms" required />
      <span>Acepto las <a class="text-sky-600" href="./terms.html" target="_blank" rel="noopener">Condiciones</a> y la <a class="text-sky-600" href="./privacy.html" target="_blank" rel="noopener">Política de privacidad</a>.</span>
    </label>

    <div id="formAlert" class="alert err hidden"></div>

    <button type="submit" class="btn primary self-start">Crear cuenta</button>
  </form>
</main>

<!--#include "partials/footer.html" -->

<script src="/js/apiClient.js"></script>
<div id="modalBackdrop" class="modal-backdrop"></div>
<div id="proModal" class="modal-backdrop" role="dialog" aria-modal="true" aria-labelledby="proTitle">
  <div class="modal">
    <h4 id="proTitle" class="text-xl font-semibold text-ink">¡Gracias! Verificación PRO</h4>
    <p class="muted">Has seleccionado un plan <strong>PRO (Solo/Team)</strong>. Te contactaremos para completar la documentación y firma antes de activar la cuenta.</p>
    <div class="actions">
      <button id="modalCancel" class="btn ghost">Cerrar</button>
      <a class="btn primary" href="./login.html">Entendido</a>
    </div>
  </div>
</div>

<script>
  const planRadios = document.querySelectorAll('input[name="plan"]');
  const teamSeatsWrap = document.getElementById('teamSeatsWrap');
  const teamSeats = document.getElementById('teamSeats');
  const nifWrap = document.getElementById('nifWrap');
  const nifInput = document.getElementById('nif');

  const sector = document.getElementById('sector');
  const sectorOtherWrap = document.getElementById('sectorOtherWrap');
  const sectorOther = document.getElementById('sector_other');

  const pwInput = document.getElementById('password');
  const pwBar = document.getElementById('pwBar');
  const pwMsg = document.getElementById('pwMsg');

  const form = document.getElementById('signupForm');
  const alertBox = document.getElementById('formAlert');
  const terms = document.getElementById('terms');

  const proModal = document.getElementById('proModal');
  const modalBackdrop = document.getElementById('modalBackdrop');
  const modalCancel = document.getElementById('modalCancel');

  const urlParams = new URLSearchParams(window.location.search);
  const planValParam = urlParams.get('planVal');
  const preSeats = urlParams.get('seats');
  let billingCode = 'M';
  if (planValParam) {
    const code = planValParam.toLowerCase();
    const letter = code.slice(-1);
    billingCode = letter === 'a' ? 'A' : 'M';
    const base = code.slice(0, -1);
    let plan;
    if (base === 'team') plan = 'Team';
    else if (base === 'solo') plan = 'Solo';
    else if (base === 'demo') plan = 'Trial';
    if (plan) {
      const r = Array.from(planRadios).find(p => p.value === plan);
      if (r) r.checked = true;
    }
  }
  if (preSeats) {
    teamSeats.value = preSeats;
  }

  function isProSelected(){
    const v = document.querySelector('input[name="plan"]:checked').value;
    return v === 'Solo' || v === 'Team';
  }
  function showError(msg){
    alertBox.textContent = msg;
    alertBox.classList.remove('hidden'); alertBox.classList.remove('ok');
    alertBox.classList.add('err');
  }
  function showOk(msg){
    alertBox.textContent = msg;
    alertBox.classList.remove('hidden'); alertBox.classList.remove('err');
    alertBox.classList.add('ok');
  }

  function normalizeNifNie(raw){
    if (!raw) return '';
    let v = raw.toUpperCase().replace(/\s|-/g,'');
    if (/^[A-Z]\d{8}$/.test(v) && !/^[XYZ]/.test(v[0])) {
      v = v.slice(1) + v[0];
    }
    if (/^[A-Z]\d{7}[XYZ]$/.test(v)) {
      v = v.slice(-1) + v.slice(1, 8) + v[0];
    }
    return v;
  }

  function validateSpanishNifNie(value) {
    if (!value) return false;
    const v = normalizeNifNie(value);
    const letters = 'TRWAGMYFPDXBNJZSQVHLCKE';
    if (/^\d{8}[A-Z]$/.test(v)) {
      const num = parseInt(v.substring(0,8), 10);
      const control = letters[num % 23];
      return v[8] === control;
    }
    if (/^[XYZ]\d{7}[A-Z]$/.test(v)) {
      const map = {X: '0', Y: '1', Z: '2'};
      const num = map[v[0]] + v.substring(1,8);
      const control = letters[parseInt(num,10) % 23];
      return v[8] === control;
    }
    if (/^[A-HJNPQRSUVW]\d{7}[0-9A-J]$/.test(v)) return true;
    return false;
  }

  function validatePostalCodeES(zip) {
    if (!zip) return true;
    return /^((0[1-9]|[1-4][0-9]|5[0-2])[0-9]{3})$/.test(zip);
  }

  function scorePassword(pw){
    let s = 0;
    if (pw.length >= 8) s++;
    if (/[A-Z]/.test(pw) && /[a-z]/.test(pw)) s++;
    if (/\d/.test(pw) && /[^A-Za-z0-9]/.test(pw)) s++;
    return s;
  }
  function renderPwMeter(){
    const s = scorePassword(pwInput.value);
    const widths = ['0%','33%','66%','100%'];
    pwBar.style.width = widths[s];
    pwBar.className = '';
    pwBar.classList.add(s<=1 ? 'pw-w1' : (s===2 ? 'pw-w2' : 'pw-w3'));
    pwMsg.textContent = s < 3 ? 'Usa mayúsculas, minúsculas, número y símbolo.' : 'Contraseña segura.';
  }

  function togglePlanExtras(){
    const v = document.querySelector('input[name="plan"]:checked').value;
    teamSeatsWrap.classList.toggle('hidden', v !== 'Team');
    const pro = isProSelected();
    nifWrap.classList.toggle('hidden', !pro);
    nifInput.required = pro;
  }

  planRadios.forEach(r => r.addEventListener('change', togglePlanExtras));
  togglePlanExtras();
  sector.addEventListener('change', () => {
    const isOther = sector.value === 'Otro';
    sectorOtherWrap.classList.toggle('hidden', !isOther);
    sectorOther.required = isOther;
  });
  pwInput.addEventListener('input', renderPwMeter);
  renderPwMeter();

  function openProModal(){ modalBackdrop.classList.add('show'); proModal.classList.add('show'); }
  function closeProModal(){ modalBackdrop.classList.remove('show'); proModal.classList.remove('show'); }
  modalBackdrop.addEventListener('click', closeProModal);
  modalCancel.addEventListener('click', closeProModal);

  async function saveJSON(url, payload){
    const r = await fetch(url, {
      method:'PUT',
      headers:{ 'Content-Type':'application/json' },
      body: JSON.stringify(payload)
    });
    if(!r.ok){ alert('Error guardando'); }
  }

  form.addEventListener('submit', async (e) => {
    e.preventDefault();
    alertBox.classList.add('hidden');

    if (!terms.checked){
      showError('Debes aceptar las Condiciones y la Privacidad para continuar.');
      terms.focus();
      return;
    }

    if (!form.checkValidity()){
      form.reportValidity();
      return;
    }

    const zip = document.getElementById('zip').value.trim();
    if (!validatePostalCodeES(zip)){
      showError('Código postal inválido para España (debe ser 01xxx–52xxx).');
      return;
    }
    if (isProSelected()){
      const nifv = nifInput.value.trim();
      if (!validateSpanishNifNie(nifv)){
        showError('NIF/DNI/NIE inválido. Aceptamos letra delante o detrás. Revisa el formato y la letra de control.');
        return;
      }
    }

    const data = Object.fromEntries(new FormData(form).entries());
    try {
      await apiClient.post('auth/register', data);
      if (isProSelected()) {
        openProModal();
      } else {
        showOk('Cuenta creada. Revisa tu correo para confirmar.');
      }
      form.reset();
      togglePlanExtras();
      renderPwMeter();
    } catch (err) {
      showError(err.message || 'No se pudo crear la cuenta.');
    }
  });
</script>
</body>
</html>
