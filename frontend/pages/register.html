<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Crear cuenta · FixHub</title>
  <link rel="stylesheet" href="/css/style.css?v={cachebust}"/>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"/>
  <style>
    .form-row{ display:grid; grid-template-columns: 1fr 1fr; gap: 14px; }
    .form-row-3{ display:grid; grid-template-columns: 1fr 1fr 1fr; gap: 14px; }
    .hint{ color: var(--muted); font-size:.95rem; margin-top:6px; }
    .chip{ display:inline-block; padding:.35rem .6rem; border-radius:999px; font-weight:700; font-size:.85rem; background:rgba(37,99,235,.08); color:var(--sky); border:1px solid rgba(37,99,235,.25); }
    .input-inline{ display:flex; gap:10px; align-items:center; }
    .hidden{ display:none !important; }

    /* Ajusta SELECT al mismo estilo que input/textarea del theme */
    select{
      width:100%; font: inherit; color:var(--ink-2);
      padding: 12px 14px; border-radius: 12px;
      border:1px solid var(--border); background:#fff;
      box-shadow: inset 0 1px 0 rgba(2,6,23,.04);
      transition: border-color .15s ease, box-shadow .15s ease;
      appearance:none; -webkit-appearance:none; -moz-appearance:none;
      background-image:
        linear-gradient(45deg, transparent 50%, var(--muted) 50%),
        linear-gradient(135deg, var(--muted) 50%, transparent 50%),
        linear-gradient(to right, transparent, transparent);
      background-position:
        calc(100% - 20px) calc(50% - 3px),
        calc(100% - 14px) calc(50% - 3px),
        calc(100% - 2.2rem) 0.6rem;
      background-size: 6px 6px, 6px 6px, 1px 60%;
      background-repeat: no-repeat;
    }
    select:focus{
      outline:none; border-color: rgba(37,99,235,.6);
      box-shadow: 0 0 0 4px rgba(37,99,235,.12);
    }

    /* Password strength */
    .pw-meter{ height:8px; border-radius:6px; background:#e5e7eb; margin-top:8px; position:relative; overflow:hidden; }
    .pw-meter > span{ position:absolute; left:0; top:0; bottom:0; width:0%; transition:width .25s ease; }
    .pw-w1{ background:#ef4444; } .pw-w2{ background:#f59e0b; } .pw-w3{ background:#10b981; }

    /* Alerts */
    .alert{ margin-top:14px; padding:12px 14px; border-radius:12px; border:1px solid var(--border); }
    .alert.ok{ background:rgba(16,185,129,.1); color:#065f46; border-color:rgba(16,185,129,.3); }
    .alert.err{ background:rgba(239,68,68,.08); color:#7f1d1d; border-color:rgba(239,68,68,.3); }

    /* Modal PRO */
    .modal-backdrop{ position:fixed; inset:0; background:rgba(0,0,0,.5); display:none; z-index:60; }
    .modal{ position:fixed; inset:0; display:none; z-index:70; align-items:center; justify-content:center; padding:20px; }
    .modal-card{ max-width:560px; width:100%; background:var(--paper); border:1px solid var(--border); border-radius:14px; padding:22px; box-shadow:var(--shadow-lg); }
    .modal h4{ margin:0 0 8px; }
    .modal .actions{ display:flex; justify-content:flex-end; gap:10px; margin-top:14px; }
    .btn.ghost{ background:#fff; color:var(--steel); border:1px solid var(--border); }
  </style>
</head>
<body>
<!--#include "partials/header.html" -->

<main>
  <h2>Crear tu cuenta</h2>
  <form id="signupForm" novalidate>
    <!-- PLAN -->
    <label>Plan <span class="chip">*  requerido</span></label>
    <div class="input-inline" role="group" aria-label="Seleccionar plan">
      <label class="input-inline"><input type="radio" name="plan" value="Trial" checked> Trial</label>
      <label class="input-inline"><input type="radio" name="plan" value="Solo"> Solo</label>
      <label class="input-inline"><input type="radio" name="plan" value="Team"> Team</label>
      <div id="teamSeatsWrap" class="input-inline hidden">
        <span>Personas:</span>
        <select id="teamSeats" name="team_seats">
          <option value="2">2</option>
          <option value="3" selected>3</option>
          <option value="4">4</option>
          <option value="5">5</option>
          <option value="6">6</option>
          <option value="7">7</option>
          <option value="8">8+</option>
        </select>
      </div>
    </div>
    <p class="hint">En planes <strong>Solo</strong> o <strong>Team</strong> pediremos documentación fiscal.</p>

    <!-- IDENTIDAD -->
    <div class="form-row">
      <div>
        <label for="email">Email *</label>
        <input id="email" name="email" type="email" required />
      </div>
      <div>
        <label for="phone">Teléfono *</label>
        <input id="phone" name="phone" type="tel" required />
      </div>
    </div>

    <div class="form-row">
      <div>
        <label for="name">Nombre *</label>
        <input id="name" name="name" required/>
      </div>
      <div>
        <label for="surname1"> Primer apellido*</label>
        <input id="surname1" name="surname1" required/>
      </div>
    </div>

    <div class="form-row">
      <div>
        <label for="surname2">Segundo apellido *</label>
        <input id="surname2" name="surname2" required/>
      </div>
      <div id="nifWrap" class="hidden">
        <label for="nif">NIF / DNI / NIE *</label>
        <input id="nif" name="nif" />      </div>
    </div>

    <!-- CONTRASEÑA -->
    <div>
      <label for="password">Contraseña *</label>
      <input id="password" name="password" type="password" required minlength="8" placeholder="Mínimo 8 caracteres"/>
      <div class="pw-meter"><span id="pwBar" class="pw-w1"></span></div>
      <p id="pwMsg" class="hint">Usa mayúsculas, minúsculas, números y símbolos.</p>
    </div>

    <div>
      <label for="password_confirm">Repetir contraseña *</label>
      <input id="password_confirm" name="password_confirm" type="password" required minlength="8" placeholder="Repite la contraseña"/>
    </div>

    <!-- EMPRESA -->
    <div class="form-row">
      <div>
        <label for="company">Empresa / Nombre comercial</label>
        <input id="company" name="company" placeholder="Opcional"/>
      </div>
      <div>
        <label for="sector">Sector / Industria *</label>
        <select id="sector" name="sector" required>
          <option value="" disabled selected>Selecciona sector</option>
          <option>Electricidad</option>
          <option>Fontanería</option>
          <option>Climatización</option>
          <option>Mantenimiento</option>
          <option>Pintura / Reformas</option>
          <option value="Otro">Otro…</option>
        </select>
      </div>
    </div>

    <div id="sectorOtherWrap" class="hidden">
      <label for="sector_other">Especifica tu sector *</label>
      <input id="sector_other" name="sector_other" placeholder="Describe tu actividad"/>
    </div>

    <!-- UBICACIÓN -->
    <div class="form-row-3">
      <div>
        <label for="country">País *</label>
        <select id="country" name="country" required>
          <option value="ES" selected>España</option>
          <option value="PT">Portugal</option>
          <option value="FR">Francia</option>
          <option value="IT">Italia</option>
        </select>
      </div>
      <div>
        <label for="region">Provincia *</label>
        <select id="region" name="region" required>
          <option value="" disabled selected></option>
            <option>A Coruña</option><option>Albacete</option><option>Alicante</option><option>Almería</option><option>Álava</option>
            <option>Asturias</option><option>Ávila</option><option>Badajoz</option><option>Barcelona</option><option>Bizkaia</option>
            <option>Burgos</option><option>Cáceres</option><option>Cádiz</option><option>Cantabria</option><option>Castellón</option>
            <option>Ciudad Real</option><option>Córdoba</option><option>Cuenca</option><option>Gipuzkoa</option><option>Girona</option>
            <option>Granada</option><option>Guadalajara</option><option>Huelva</option><option>Huesca</option><option>Illes Balears</option>
            <option>Jaén</option><option>La Rioja</option><option>Las Palmas</option><option>León</option><option>Lleida</option><option>Lugo</option>
            <option>Madrid</option><option>Málaga</option><option>Murcia</option><option>Navarra</option><option>Ourense</option>
            <option>Palencia</option><option>Pontevedra</option><option>Salamanca</option><option>Santa Cruz de Tenerife</option>
            <option>Segovia</option><option>Sevilla</option><option>Soria</option><option>Tarragona</option><option>Teruel</option>
            <option>Toledo</option><option>València</option><option>Valladolid</option><option>Zamora</option><option>Zaragoza</option>        </select>
      </div>
      <div>
        <label for="zip">Código Postal</label>
        <input id="zip" name="zip" inputmode="numeric" pattern="[0-9]{5}" placeholder="00000"/>
      </div>
    </div>

    <!-- Términos -->
    <label class="input-inline">
    <input type="checkbox" id="terms" required>
    <span>
        Acepto las <a href="./condiciones.html" target="_blank" rel="noopener">Condiciones</a> 
        y la <a href="./privacy.html" target="_blank" rel="noopener">Política de privacidad</a>.
    </span>
    </label>

    <div id="formAlert" class="alert err hidden"></div>

    <button type="submit" class="btn primary" style="margin-top:22px">Crear cuenta</button>
  </form>
</main>

<!--#include "partials/footer.html" -->
<script src="/js/apiClient.js"></script>

<!-- Modal PRO -->
<div id="modalBackdrop" class="modal-backdrop"></div>
<div id="proModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="proTitle">
  <div class="modal-card">
    <h4 id="proTitle">¡Gracias! Verificación PRO</h4>
    <p>Has seleccionado un plan <strong>PRO (Solo/Team)</strong>. Te contactaremos para completar la documentación y firma antes de activar la cuenta.</p>
    <div class="actions">
      <button id="modalCancel" class="btn ghost">Cerrar</button>
      <a class="btn primary" href="./login.html">Entendido</a>
    </div>
  </div>
</div>

<script>
  // ----- Elements
  const planRadios = document.querySelectorAll('input[name="plan"]');
  const teamSeatsWrap = document.getElementById('teamSeatsWrap');
  const teamSeats = document.getElementById('teamSeats');
  const nifWrap = document.getElementById('nifWrap');
  const nifInput = document.getElementById('nif');

  const sector = document.getElementById('sector');
  const sectorOtherWrap = document.getElementById('sectorOtherWrap');
  const sectorOther = document.getElementById('sector_other');

  const pwInput = document.getElementById('password');
  const pwBar = document.getElementById('pwBar');
  const pwMsg = document.getElementById('pwMsg');

  const form = document.getElementById('signupForm');
  const alertBox = document.getElementById('formAlert');
  const terms = document.getElementById('terms');

  // Modal
  const proModal = document.getElementById('proModal');
  const modalBackdrop = document.getElementById('modalBackdrop');
  const modalCancel = document.getElementById('modalCancel');

  // Preselect plan & billing via query params
  const urlParams = new URLSearchParams(window.location.search);
  const planValParam = urlParams.get('planVal');
  const preSeats = urlParams.get('seats');
  let billingCode = 'M';
  if (planValParam) {
    const code = planValParam.toLowerCase();
    const letter = code.slice(-1);
    billingCode = letter === 'a' ? 'A' : 'M';
    const base = code.slice(0, -1);
    let plan;
    if (base === 'team') plan = 'Team';
    else if (base === 'solo') plan = 'Solo';
    else if (base === 'demo') plan = 'Trial';
    if (plan) {
      const r = Array.from(planRadios).find(p => p.value === plan);
      if (r) r.checked = true;
    }
  }
  if (preSeats) {
    teamSeats.value = preSeats;
  }

  // ----- Helpers
  function isProSelected(){
    const v = document.querySelector('input[name="plan"]:checked').value;
    return v === 'Solo' || v === 'Team';
  }
  function showError(msg){
    alertBox.textContent = msg;
    alertBox.classList.remove('hidden'); alertBox.classList.remove('ok');
    alertBox.classList.add('err');
  }
  function showOk(msg){
    alertBox.textContent = msg;
    alertBox.classList.remove('hidden'); alertBox.classList.remove('err');
    alertBox.classList.add('ok');
  }

  // NIF/NIE flexible: acepta letra de control delante o detrás
  function normalizeNifNie(raw){
    if (!raw) return '';
    let v = raw.toUpperCase().replace(/\s|-/g,'');
    // Caso NIF con letra al inicio: A12345678 -> 12345678A
    if (/^[A-Z]\d{8}$/.test(v) && !/^[XYZ]/.test(v[0])) {
      v = v.slice(1) + v[0];
    }
    // Caso NIE con letra de control al inicio y X/Y/Z al final: T1234567X -> X1234567T
    if (/^[A-Z]\d{7}[XYZ]$/.test(v)) {
      v = v.slice(-1) + v.slice(1, 8) + v[0];
    }
    return v;
  }

  function validateSpanishNifNie(value) {
    if (!value) return false;
    const v = normalizeNifNie(value);

    const letters = 'TRWAGMYFPDXBNJZSQVHLCKE';

    // NIF estándar: 8 dígitos + letra
    if (/^\d{8}[A-Z]$/.test(v)) {
      const num = parseInt(v.substring(0,8), 10);
      const control = letters[num % 23];
      return v[8] === control;
    }
    // NIE estándar: X/Y/Z + 7 dígitos + letra
    if (/^[XYZ]\d{7}[A-Z]$/.test(v)) {
      const map = {X: '0', Y: '1', Z: '2'};
      const num = map[v[0]] + v.substring(1,8);
      const control = letters[parseInt(num,10) % 23];
      return v[8] === control;
    }
    // CIF (empresas) — validación básica
    if (/^[A-HJNPQRSUVW]\d{7}[0-9A-J]$/.test(v)) return true;

    return false;
  }

  // ES postal code
  function validatePostalCodeES(zip) {
    if (!zip) return true; // opcional
    return /^((0[1-9]|[1-4][0-9]|5[0-2])[0-9]{3})$/.test(zip);
  }

  // Password strength
  function scorePassword(pw){
    let s = 0;
    if (pw.length >= 8) s++;
    if (/[A-Z]/.test(pw) && /[a-z]/.test(pw)) s++;
    if (/\d/.test(pw) && /[^A-Za-z0-9]/.test(pw)) s++;
    return s; // 0..3
  }
  function renderPwMeter(){
    const s = scorePassword(pwInput.value);
    const widths = ['0%','33%','66%','100%'];
    pwBar.style.width = widths[s];
    pwBar.className = '';
    pwBar.classList.add(s<=1 ? 'pw-w1' : (s===2 ? 'pw-w2' : 'pw-w3'));
    pwMsg.textContent = s < 3 ? 'Usa mayúsculas, minúsculas, número y símbolo.' : 'Contraseña segura.';
  }

  // UI toggles
  function togglePlanExtras(){
    const v = document.querySelector('input[name="plan"]:checked').value;
    teamSeatsWrap.classList.toggle('hidden', v !== 'Team');
    const pro = isProSelected();
    nifWrap.classList.toggle('hidden', !pro);
    nifInput.required = pro;
  }

  planRadios.forEach(r => r.addEventListener('change', togglePlanExtras));
  togglePlanExtras();
  sector.addEventListener('change', () => {
    const isOther = sector.value === 'Otro';
    sectorOtherWrap.classList.toggle('hidden', !isOther);
    sectorOther.required = isOther;
  });
  pwInput.addEventListener('input', renderPwMeter);
  renderPwMeter();

  // Modal
  function openProModal(){ modalBackdrop.style.display='block'; proModal.style.display='flex'; }
  function closeProModal(){ modalBackdrop.style.display='none'; proModal.style.display='none'; }
  modalBackdrop.addEventListener('click', closeProModal);
  modalCancel.addEventListener('click', closeProModal);

  // Submit
  form.addEventListener('submit', async (e) => {
    e.preventDefault();
    alertBox.classList.add('hidden');

    // Aceptación de términos (HTML5 ya bloquea, pero reforzamos)
    if (!terms.checked){
      showError('Debes aceptar las Condiciones y la Privacidad para continuar.');
      terms.focus();
      return;
    }

    // HTML5
    if (!form.checkValidity()){
      form.reportValidity();
      return;
    }

    // Extra validations
    const zip = document.getElementById('zip').value.trim();
    if (!validatePostalCodeES(zip)){
      showError('Código postal inválido para España (debe ser 01xxx–52xxx).');
      return;
    }
    if (isProSelected()){
      const nifv = nifInput.value.trim();
      if (!validateSpanishNifNie(nifv)){
        showError('NIF/DNI/NIE inválido. Aceptamos letra delante o detrás. Revisa el formato y la letra de control.');
        return;
      }
    }

    const pw = document.getElementById('password').value;
    const pw2 = document.getElementById('password_confirm').value;
    if (pw !== pw2){
      showError('Las contraseñas no coinciden.');
      return;
    }

    // Build payload
    const planSel = document.querySelector('input[name="plan"]:checked').value;
    const base = planSel === 'Trial' ? 'demo' : planSel.toLowerCase();
    const planVal = `${base}${billingCode}`;
    const payload = {
      license: planVal,
      team_members: planSel === 'Team' ? parseInt(teamSeats.value, 10) : 1,
      email: document.getElementById('email').value.trim(),
      telephone: document.getElementById('phone').value.trim(),
      first_name: document.getElementById('name').value.trim(),
      surname1: document.getElementById('surname1').value.trim(),
      surname2: document.getElementById('surname2').value.trim(),
      nif: (isProSelected() ? document.getElementById('nif').value.trim() : ''),
      password: pw,
      confirm_password: pw2,
      company_name: document.getElementById('company').value.trim(),
      sector: (sector.value === 'Otro' ? sectorOther.value.trim() : sector.value),
      country: document.getElementById('country').value,
      state: document.getElementById('region').value,
      zip_code: zip,
      terms_accepted: terms.checked,
    };

    try{
      if (!localStorage.getItem('deviceId')) {
        const newId = self.crypto?.randomUUID ? self.crypto.randomUUID() : Math.random().toString(36).slice(2);
        localStorage.setItem('deviceId', newId);
      }
      await apiClient.post('auth/register', payload);
      showOk('Cuenta creada correctamente.');
      if (isProSelected()) { openProModal(); }
      else { window.location.href = './login.html'; }
    } catch (err){
      if (err.status === 409){ showError('Ya existe una cuenta con ese email.'); return; }
      if (err.status === 422){ showError(err.body?.message || 'Datos inválidos. Revisa los campos.'); return; }
      if (err.status === 429){ showError('Demasiadas solicitudes. Inténtalo más tarde.'); return; }
      if (err.status === 403){ showError('No tienes permisos para este plan actualmente.'); return; }
      if (err.status === 500){ showError('Error del servidor. Inténtalo de nuevo.'); return; }
      showError(err.message || 'No se pudo conectar con el servidor.');
      console.error(err);
    }
  });
</script>
</body>
</html>
