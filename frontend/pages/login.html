<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>FixHub — Área PRO</title>
  <!--#include "partials/tailwind.html" -->
</head>
<body class="auth-body">
  <!--#include "partials/header.html" -->

  <main class="auth-wrap">
    <section class="auth-card" aria-labelledby="t">
      <div class="auth-header">
        <div class="auth-logo" aria-hidden="true"></div>
        <h1 id="t" class="text-xl font-bold text-ink">FixHub — Área PRO</h1>
      </div>
      <p class="auth-subtitle" id="subtitle">Acceso a la plataforma</p>

      <div id="alert" class="alert hidden" role="alert" aria-live="assertive" aria-hidden="true">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" aria-hidden="true" class="mt-0.5 text-rose-600">
          <path d="M12 9v4m0 4h.01M10.29 3.86 1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
        <div>
          <strong></strong>
          <div class="hint"></div>
        </div>
      </div>

      <form id="loginForm" class="grid gap-4" novalidate>
        <label for="email">Correo electrónico o usuario</label>
        <input id="email" name="email" type="email" class="input" autocomplete="off" required />

        <label for="password">Contraseña</label>
        <div class="flex items-center gap-3">
          <input id="password" name="password" type="password" class="input flex-1" autocomplete="off" aria-describedby="pwd-hint" required />
          <button type="button" id="togglePwd" class="btn ghost px-4 py-2">Mostrar</button>
        </div>

        <button class="btn primary" type="submit">Iniciar sesión</button>
      </form>

      <form id="forgotForm" class="hidden grid gap-4" novalidate>
        <label for="fEmail">Correo electrónico o usuario</label>
        <input id="fEmail" name="email" type="text" class="input" autocomplete="off" required />
        <button class="btn primary" type="submit">Enviar</button>
        <div id="forgotMsg" class="hint"></div>
      </form>

      <form id="resetForm" class="hidden grid gap-4" novalidate>
        <label for="newPassword">Nueva contraseña</label>
        <input id="newPassword" type="password" class="input" autocomplete="off" required />
        <label for="confirmPassword">Confirmar contraseña</label>
        <input id="confirmPassword" type="password" class="input" autocomplete="off" required />
        <button class="btn primary" type="submit">Restablecer contraseña</button>
      </form>

      <div class="auth-foot">
        <div class="flex flex-wrap items-center gap-3">
          <a class="text-sky-600 hover:text-sky-500" href="#" id="forgotLink">¿Olvidaste la contraseña?</a>
          <a class="text-sky-600 hover:text-sky-500 hidden" href="#" id="loginLink">Iniciar sesión</a>
        </div>
        <a class="text-slate-600 hover:text-slate-900" href="/">Volver al inicio</a>
      </div>
    </section>
  </main>

  <!--#include "partials/footer.html" -->

  <script src="/js/apiClient.js"></script>
  <script>
    const loginForm = document.getElementById('loginForm');
    const forgotForm = document.getElementById('forgotForm');
    const resetForm = document.getElementById('resetForm');
    const forgotMsg = document.getElementById('forgotMsg');
    const alertBox = document.getElementById('alert');
    const alertText = alertBox.querySelector('strong');
    const alertHint = alertBox.querySelector('.hint');
    const subtitle = document.getElementById('subtitle');
    const togglePwd = document.getElementById('togglePwd');
    const pwd = document.getElementById('password');
    const forgotLink = document.getElementById('forgotLink');
    const loginLink = document.getElementById('loginLink');
    const submitBtn = loginForm.querySelector('button[type="submit"]');
    let throttled = false;
    let lastForgot = 0;

    function showAlert(text, hint) {
      alertText.textContent = text || 'Ha ocurrido un error';
      alertHint.textContent = hint || '';
      alertBox.classList.remove('hidden');
      alertBox.removeAttribute('aria-hidden');
      alertBox.classList.remove('animation-shake');
      void alertBox.offsetWidth;
      alertBox.classList.add('animation-shake');
      alertBox.setAttribute('tabindex','-1'); alertBox.focus({preventScroll:true});
    }
    function hideAlert(){ alertBox.classList.add('hidden'); alertBox.setAttribute('aria-hidden','true'); }

    function showView(view) {
      loginForm.classList.add('hidden');
      forgotForm.classList.add('hidden');
      resetForm.classList.add('hidden');
      forgotMsg.textContent = '';
      hideAlert();
      if (view === 'login') {
        loginForm.classList.remove('hidden');
        subtitle.textContent = 'Acceso a la plataforma';
        forgotLink.classList.remove('hidden');
        loginLink.classList.add('hidden');
      } else if (view === 'forgot') {
        forgotForm.classList.remove('hidden');
        subtitle.textContent = 'Recupera tu contraseña';
        forgotLink.classList.add('hidden');
        loginLink.classList.remove('hidden');
      } else if (view === 'reset') {
        resetForm.classList.remove('hidden');
        subtitle.textContent = 'Establece una nueva contraseña';
        forgotLink.classList.add('hidden');
        loginLink.classList.remove('hidden');
      }
    }

    forgotLink.addEventListener('click', (e) => { e.preventDefault(); showView('forgot'); });
    loginLink.addEventListener('click',  (e) => { e.preventDefault(); showView('login');  });

    togglePwd.addEventListener('click', () => {
      const isPwd = pwd.type === 'password';
      pwd.type = isPwd ? 'text' : 'password';
      togglePwd.textContent = isPwd ? 'Ocultar' : 'Mostrar';
      pwd.focus();
    });

    function getDeviceId(){
      const k = 'fixhub_device_id';
      let id = localStorage.getItem(k);
      if (!id) {
        id = ([1e7]+-1e3+-4e3+-8e3+-1e11).replace(/[018]/g, c =>
          (c ^ crypto.getRandomValues(new Uint8Array(1))[0] & 15 >> c / 4).toString(16)
        );
        localStorage.setItem(k, id);
      }
      return id;
    }

    loginForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      if (throttled) return;
      hideAlert();
      submitBtn.disabled = true;
      const payload = {
        email: document.getElementById('email').value.trim(),
        password: pwd.value,
        deviceId: getDeviceId(),
      };
      try {
        await apiClient.post('auth/login', payload);
        window.location = '/dashboard.html';
      } catch (err) {
        showAlert('No se pudo iniciar sesión', err.message || 'Comprueba los datos e inténtalo de nuevo.');
      } finally {
        submitBtn.disabled = false;
      }
    });

    forgotForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      const now = Date.now();
      if (now - lastForgot < 15000) {
        forgotMsg.textContent = 'Espera unos segundos antes de reenviar.';
        return;
      }
      lastForgot = now;
      forgotMsg.textContent = '';
      try {
        await apiClient.post('auth/forgot', { email: document.getElementById('fEmail').value.trim() });
        forgotMsg.textContent = 'Si existe una cuenta, recibirás instrucciones.';
      } catch (err) {
        forgotMsg.textContent = err.message || 'No se pudo enviar el correo.';
      }
    });

    resetForm.addEventListener('submit', (e) => {
      e.preventDefault();
      showAlert('Función no disponible', 'Activa el endpoint de restablecimiento para completar esta vista.');
    });
  </script>
</body>
</html>
