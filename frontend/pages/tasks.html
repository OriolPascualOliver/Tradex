<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>FixHub · Tareas</title>
  <!--#include "partials/tailwind.html" -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" integrity="sha512-pIVp9sPu0YdHDi3uL1l5X8GZFODdgNpTi27C1l2qCkCmZJLdnOjFkWDXLI4YAlnXrhIR3IuAeGHGZk+y3OC/qw==" crossorigin="anonymous" referrerpolicy="no-referrer" />
</head>
<body>
<!--#include "partials/header.html" -->

<main class="page-container">
  <section class="card">
    <h1 class="text-2xl font-semibold text-ink">Tareas</h1>
    <form id="taskForm" class="mt-4 flex flex-wrap items-center gap-3" novalidate>
      <input id="taskTitle" class="input flex-1" placeholder="Nueva tarea…" required />
      <label class="input-inline" title="Urgente">
        <input id="taskUrgent" type="checkbox" />
        <span>Urgente</span>
      </label>
      <button class="btn primary" type="submit">Añadir</button>
    </form>
    <div id="tasksBox" class="mt-6 grid gap-3"></div>
  </section>
</main>

<!--#include "partials/footer.html" -->

<script src="/js/apiClient.js"></script>
<script>
  const box = document.getElementById('tasksBox');
  const form = document.getElementById('taskForm');
  const title = document.getElementById('taskTitle');
  const urgent = document.getElementById('taskUrgent');

  async function loadTasks(){
    const res = await fetch('/v1/tasks');
    const data = await res.json().catch(()=>({}));
    const items = Array.isArray(data?.items) ? data.items : [];
    box.innerHTML = '';
    if (!items.length) {
      box.innerHTML = '<p class="muted">No hay tareas.</p>';
      return;
    }
    items.forEach(t => {
      const row = document.createElement('div');
      row.className = 'job-pill flex-wrap';

      const label = document.createElement('label');
      label.className = 'input-inline gap-2';

      const chk = document.createElement('input');
      chk.type = 'checkbox';
      if (t.done) chk.checked = true;
      chk.setAttribute('class', 'chk');
      chk.setAttribute('data-id', t.id);

      const titleSpan = document.createElement('span');
      if (t.done) titleSpan.classList.add('line-through', 'text-slate-400');
      titleSpan.textContent = t.title;

      label.appendChild(chk);
      label.appendChild(titleSpan);

      const actions = document.createElement('div');
      actions.className = 'flex items-center gap-2';

      if (t.urgent) {
        const urgentSpan = document.createElement('span');
        urgentSpan.className = 'pill';
        urgentSpan.title = 'Urgente';
        urgentSpan.textContent = '⚠';
        actions.appendChild(urgentSpan);
      }

      const deleteBtn = document.createElement('button');
      deleteBtn.className = 'btn secondary sm del';
      deleteBtn.setAttribute('data-id', t.id);
      deleteBtn.textContent = 'Eliminar';
      actions.appendChild(deleteBtn);

      row.innerHTML = '';
      row.appendChild(label);
      row.appendChild(actions);

      box.appendChild(row);
    });

    box.querySelectorAll('.chk').forEach(chk => {
      chk.addEventListener('change', async (e) => {
        const id = e.target.dataset.id;
        await fetch(`/v1/tasks/${id}`, {
          method: 'PATCH',
          headers: {'Content-Type':'application/json'},
          body: JSON.stringify({ done: e.target.checked })
        });
        loadTasks();
      });
    });
    box.querySelectorAll('.del').forEach(btn => {
      btn.addEventListener('click', async () => {
        const id = btn.dataset.id;
        await fetch(`/v1/tasks/${id}`, { method:'DELETE' });
        loadTasks();
      });
    });
  }

  form.addEventListener('submit', async (e) => {
    e.preventDefault();
    const payload = { title: title.value.trim(), urgent: urgent.checked };
    if (!payload.title) return;
    await fetch('/v1/tasks', {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify(payload)
    });
    title.value = '';
    urgent.checked = false;
    loadTasks();
  });

  loadTasks();
</script>
</body>
</html>
