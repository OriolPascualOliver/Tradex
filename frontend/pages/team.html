<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>FixHub · Equipo</title>
  <!--#include "partials/tailwind.html" -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" integrity="sha512-pIVp9sPu0YdHDi3uL1l5X8GZFODdgNpTi27C1l2qCkCmZJLdnOjFkWDXLI4YAlnXrhIR3IuAeGHGZk+y3OC/qw==" crossorigin="anonymous" referrerpolicy="no-referrer" />
</head>
<body>
<!--#include "partials/header.html" -->

<main class="wrap">
  <section class="card" id="planCard">
    <div class="flex flex-wrap items-center justify-between gap-4">
      <div>
        <div class="kicker uppercase tracking-wide text-slate-500">Plan actual</div>
        <h2 id="planName" class="text-3xl font-semibold text-ink">—</h2>
        <p id="planNote" class="muted-sm mt-2">—</p>
      </div>
      <div class="flex flex-wrap items-center gap-3">
        <button class="btn sm" id="btnChangePlan"><i class="fa-solid fa-arrows-rotate"></i> Cambiar plan / equipo</button>
        <a class="btn sm" href="./pricing.html"><i class="fa-regular fa-circle-question"></i> Ver planes</a>
      </div>
    </div>
  </section>

  <section class="card hide" id="teamCard">
    <div class="toolbar justify-between">
      <div>
        <div class="kicker uppercase tracking-wide text-slate-500">Tu equipo</div>
        <h3 class="text-2xl font-semibold text-ink mt-1"><span id="orgName">—</span> · <span id="teamSizeBadge" class="chip">0 personas</span></h3>
      </div>
      <div class="flex flex-wrap items-center gap-2">
        <button class="btn secondary sm" id="btnAdd"><i class="fa-solid fa-user-plus"></i> Añadir</button>
        <button class="btn sm" id="btnRefresh"><i class="fa-solid fa-rotate"></i> Actualizar</button>
      </div>
    </div>

    <div class="mt-4 overflow-x-auto">
      <table class="table" id="teamTable" aria-describedby="orgName">
        <thead>
          <tr>
            <th>Usuario</th>
            <th>Rol</th>
            <th>Estado</th>
            <th class="right">Acciones</th>
          </tr>
        </thead>
        <tbody id="teamBody">
          <tr><td colspan="4" class="muted-sm">Cargando equipo…</td></tr>
        </tbody>
      </table>
    </div>
  </section>
</main>

<!--#include "partials/footer.html" -->

<div class="modal-backdrop" id="modalMember" role="dialog" aria-modal="true" aria-hidden="true">
  <div class="modal" role="document">
    <h3 id="memberTitle" class="text-xl font-semibold text-ink">Añadir miembro</h3>
    <div class="grid gap-4">
      <label>Nombre
        <input id="fName" class="input" placeholder="Nombre y apellidos" />
      </label>
      <label>Email
        <input id="fEmail" class="input" type="email" placeholder="persona@empresa.com" />
      </label>
      <label>Rol
        <select id="fRole" class="input">
          <option value="worker">Técnico</option>
          <option value="manager">Manager</option>
          <option value="admin">Admin</option>
        </select>
      </label>
      <label class="input-inline">
        <input type="checkbox" id="fActive" checked />
        <span>Activo</span>
      </label>
    </div>
    <div class="actions">
      <button class="btn sm" id="btnCancelMember">Cancelar</button>
      <button class="btn primary sm" id="btnSaveMember">Guardar</button>
    </div>
    <p id="memberMsg" class="muted-sm"></p>
  </div>
</div>

<div class="modal-backdrop modal-wide" id="modalPlan" role="dialog" aria-modal="true" aria-hidden="true">
  <div class="modal" role="document">
    <h3 class="text-xl font-semibold text-ink">Cambiar plan / tamaño de equipo</h3>
    <div class="grid gap-4">
      <label>Plan
        <select id="mPlan" class="input">
          <option value="Solo">Solo</option>
          <option value="Team">Team</option>
        </select>
      </label>
      <div id="teamSelector" class="inline">
        <label for="mTeamSize" class="font-semibold">Personas</label>
        <select id="mTeamSize" class="input min-w-[120px]">
          <option value="1">1</option><option value="2">2</option><option value="3">3</option>
          <option value="4">4</option><option value="5">5</option><option value="6">6</option>
          <option value="7">7</option><option value="8">8+</option>
        </select>
      </div>
      <div class="summary" id="priceSummary">
        <div><strong>Resumen de precio</strong></div>
        <div class="muted-sm" id="priceText">—</div>
      </div>
      <label class="input-inline">
        <input type="checkbox" id="ackPrice" />
        <span>Entiendo y acepto el cambio de precio.</span>
      </label>
    </div>
    <div class="actions">
      <button class="btn sm" id="btnCancelPlan">Cancelar</button>
      <button class="btn primary sm" id="btnSavePlan" disabled>Confirmar cambio</button>
    </div>
    <p id="planMsg" class="muted-sm"></p>
  </div>
</div>

<script type="module">
import { formatEUR, computeTeamMonthly } from '/js/pricing-lib.js';

const token = localStorage.getItem('token') || '';

let PRICING = null;
async function loadPricing(){
  try{
    const res = await fetch('/api-v1/pricing');
    if(!res.ok) throw 0;
    PRICING = await res.json();
  }catch(e){
    PRICING = {
      currency:'EUR', vatIncluded:false, annualDiscount:0.10,
      solo:{ monthly:49 },
      team:{ tiers:[
        {maxSeats:1,price:45},{maxSeats:2,price:45},{maxSeats:3,price:35},
        {maxSeats:4,price:33},{maxSeats:5,price:30},{maxSeats:6,price:28},
        {maxSeats:7,price:27},{maxSeats:99,price:27}
      ]}
    };
  }
}

await loadPricing();

let org = { id:null, name:'—', plan:'Solo', teamMembers: 1 };
let team = [];
let editingMemberId = null;

const $ = (id) => document.getElementById(id);
function authHeaders() {
  const h = { 'Content-Type': 'application/json' };
  if (token) h['Authorization'] = 'Bearer ' + token;
  return h;
}
async function saveJSON(url, payload){
  const res = await fetch(url, {
    method:'PUT',
    headers: authHeaders(),
    body: JSON.stringify(payload)
  });
  if(!res.ok) throw new Error('request');
}
function fmtEUR(x){ return formatEUR(x); }
function show(el){ el.classList.add('show'); el.classList.remove('hidden'); el.setAttribute('aria-hidden','false'); }
function hide(el){ el.classList.remove('show'); el.classList.add('hidden'); el.setAttribute('aria-hidden','true'); }

async function loadOrg(){
  try{
    const res = await fetch(`/api-v1/org/me`, { headers: authHeaders() });
    if(!res.ok) throw new Error('org');
    const data = await res.json();
    org = {
      id: data?.org?.id || null,
      name: data?.org?.name || 'Tu organización',
      plan: data?.plan || 'Solo',
      teamMembers: data?.teamMembers ?? 1
    };
  }catch(e){
    org = { id:'demo-org', name:'DEMO: ACME', plan:'Team', teamMembers: 3 };
  } finally {
    renderPlan();
  }
}
async function loadTeam(){
  if (!org.id || org.plan.toLowerCase()!=='team') return renderTeam(true);
  try{
    const res = await fetch(`/api-v1/team?orgId=${encodeURIComponent(org.id)}`, { headers: authHeaders() });
    if(!res.ok) throw new Error('team');
    const data = await res.json();
    team = Array.isArray(data?.items) ? data.items : [];
  }catch(e){
    team = [
      { id:'1', email:'pepito@example.com', name:'Pepito', role:'worker', active:true },
      { id:'2', email:'maria@example.com', name:'María', role:'manager', active:true },
      { id:'3', email:'mariona@example.com', name:'Mariona', role:'admin', active:false },
      { id:'4', email:'oriol@example.com', name:'Oriol', role:'worker', active:true },
    ];
  } finally {
    renderTeam();
  }
}

function renderPlan(){
  $('planName').textContent = org.plan;
  $('planNote').textContent = (org.plan.toLowerCase()==='team')
    ? `Actualmente ${org.teamMembers} persona${org.teamMembers>1?'s':''} en el plan Team.`
    : 'Gestión de equipo disponible al pasar a Team.';
  $('orgName').textContent = org.name;
  $('teamSizeBadge').textContent = `${org.teamMembers} persona${org.teamMembers>1?'s':''}`;
  if (org.plan.toLowerCase()==='team') {
    $('teamCard').classList.remove('hide');
  } else {
    $('teamCard').classList.add('hide');
  }
}
function roleLabel(r){ return r==='admin'?'Admin':(r==='manager'?'Manager':'Técnico'); }
function renderTeam(skipWhenSolo=false){
  const body = $('teamBody');
  if (skipWhenSolo || org.plan.toLowerCase()!=='team'){
    body.innerHTML = `<tr><td colspan="4" class="muted-sm">Gestiona tu equipo al activar el plan Team.</td></tr>`;
    return;
  }
  if (!team.length) {
    body.innerHTML = `<tr><td colspan="4" class="muted-sm">Aún no hay miembros. Añade el primero.</td></tr>`;
    return;
  }
  body.innerHTML = '';
  team.forEach(m=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>
        <div class="font-semibold text-ink">${m.name || '(sin nombre)'}</div>
        <div class="muted-sm">${m.email || ''}</div>
      </td>
      <td><span class="chip">${roleLabel(m.role)}</span></td>
      <td>${m.active ? '<span class="badge ok">Activo</span>' : '<span class="badge error">Inactivo</span>'}</td>
      <td class="right space-x-2">
        <button class="btn sm" data-act="toggle" data-id="${m.id}">${m.active?'<i class="fa-regular fa-circle-pause"></i> Desactivar':'<i class="fa-regular fa-circle-play"></i> Activar'}</button>
        <button class="btn secondary sm" data-act="edit" data-id="${m.id}"><i class="fa-solid fa-pen-to-square"></i> Editar</button>
        <button class="btn danger sm" data-act="del" data-id="${m.id}"><i class="fa-regular fa-trash-can"></i> Eliminar</button>
      </td>`;
    body.appendChild(tr);
  });
  body.querySelectorAll('button').forEach(b=>b.addEventListener('click', onRowAction));
}

async function onRowAction(e){
  const id = e.currentTarget.getAttribute('data-id');
  const act = e.currentTarget.getAttribute('data-act');
  const m = team.find(x=>x.id===id); if(!m) return;
  if (act==='edit') return openMember(m);
  if (act==='toggle') return saveMember({ ...m, active: !m.active });
  if (act==='del'){
    if (!confirm('¿Eliminar este miembro?')) return;
    return deleteMember(id);
  }
}

function openMember(m){
  editingMemberId = m?.id || null;
  $('memberTitle').textContent = editingMemberId ? 'Editar miembro' : 'Añadir miembro';
  $('fName').value = m?.name || '';
  $('fEmail').value = m?.email || '';
  $('fRole').value = m?.role || 'worker';
  $('fActive').checked = m?.active ?? true;
  $('memberMsg').textContent = '';
  show($('modalMember'));
}
$('btnCancelMember').onclick = ()=> hide($('modalMember'));
$('btnSaveMember').onclick = async ()=>{
  const name = $('fName').value.trim();
  const email = $('fEmail').value.trim();
  const role = $('fRole').value;
  const active = $('fActive').checked;
  if (!email){ $('memberMsg').textContent='El email es obligatorio.'; return; }
  await saveMember({ id: editingMemberId, name, email, role, active });
  hide($('modalMember'));
};
$('modalMember').addEventListener('click', e=>{ if (e.target.id==='modalMember') hide($('modalMember')); });

async function saveMember(payload){
  try{
    if (payload.id){
      const res = await fetch(`/api-v1/team/${encodeURIComponent(payload.id)}`, {
        method:'PATCH', headers: authHeaders(),
        body: JSON.stringify({ name: payload.name, email: payload.email, role: payload.role, active: payload.active })
      });
      if(!res.ok) throw 0;
    } else {
      const res = await fetch(`/api-v1/team`, {
        method:'POST', headers: authHeaders(),
        body: JSON.stringify({ orgId: org.id, name: payload.name, email: payload.email, role: payload.role })
      });
      if(!res.ok) throw 0;
    }
  }catch(e){ alert('No se pudo guardar.'); }
  await loadTeam();
}
async function deleteMember(id){
  try{
    const res = await fetch(`/api-v1/team/${encodeURIComponent(id)}`, { method:'DELETE', headers: authHeaders() });
    if(!res.ok) throw 0;
  }catch(e){ alert('No se pudo eliminar.'); }
  await loadTeam();
}

function openPlanModal(){
  $('mPlan').value = org.plan;
  $('mTeamSize').value = String(Math.min(Math.max(org.teamMembers||1,1),7));
  $('ackPrice').checked = false;
  $('btnSavePlan').disabled = true;
  refreshPriceSummary();
  toggleTeamSelector();
  $('planMsg').textContent = '';
  show($('modalPlan'));
}
function toggleTeamSelector(){
  const wrap = $('teamSelector');
  const isTeam = $('mPlan').value === 'Team';
  wrap.classList.toggle('hidden', !isTeam);
  refreshPriceSummary();
}
function refreshPriceSummary(){
  const plan = $('mPlan').value;
  let text = '';
  if (plan === 'Solo') {
    text = `Plan Solo: tarifa única de ${fmtEUR(PRICING.solo.monthly)} /mes (*IVA no incluido).`;
  } else {
    const n = Number($('mTeamSize').value);
    const { seat, total } = computeTeamMonthly(n, PRICING.team.tiers);
    text = `Plan Team para ${n} persona${n>1?'s':''}: ${fmtEUR(seat)} por persona · Total estimado: ${fmtEUR(total)} al mes (*IVA no incluido).`;
    if (org.plan==='Team' && org.teamMembers){
      const { total: oldTotal } = computeTeamMonthly(org.teamMembers, PRICING.team.tiers);
      const delta = total - oldTotal;
      text += ` ${delta===0?'(sin cambios)':'Cambio mensual: ' + (delta>0?'+':'') + fmtEUR(delta)}`;
    }
  }
  $('priceText').textContent = text;
}

$('btnChangePlan').onclick = openPlanModal;
$('btnCancelPlan').onclick = () => hide($('modalPlan'));
$('mPlan').addEventListener('change', toggleTeamSelector);
$('mTeamSize').addEventListener('change', refreshPriceSummary);
$('ackPrice').addEventListener('change', () => {
  $('btnSavePlan').disabled = !$('ackPrice').checked;
});
$('btnSavePlan').onclick = async () => {
  $('planMsg').textContent = '';
  try{
    await saveJSON(`/api-v1/org/plan`, {
      plan: $('mPlan').value,
      seats: Number($('mTeamSize').value || 1)
    });
    $('planMsg').textContent = 'Cambio solicitado.';
    await loadOrg();
    await loadTeam();
  }catch(e){
    $('planMsg').textContent = 'No se pudo guardar.';
  }
};

$('btnAdd').onclick = () => openMember();
$('btnRefresh').onclick = () => loadTeam();

await loadOrg();
await loadTeam();
</script>
</body>
</html>
